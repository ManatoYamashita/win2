name: AFBæˆæœãƒ‡ãƒ¼ã‚¿åŒæœŸ

# å®šæœŸçš„ã«AFB APIã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã€æˆæœãƒ‡ãƒ¼ã‚¿ã‚’Google Sheetsã«åŒæœŸ
# Vercel Free Planã®Cronåˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã€GitHub Actions Schedulerã‚’ä½¿ç”¨

on:
  schedule:
    # 10åˆ†æ¯ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“: æ¯æ™‚0åˆ†ã€10åˆ†ã€20åˆ†ã€30åˆ†ã€40åˆ†ã€50åˆ†ï¼‰
    - cron: '*/10 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      days:
        description: 'å–å¾—ã™ã‚‹éå»ã®æ—¥æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7æ—¥é–“ï¼‰'
        required: false
        default: '7'

jobs:
  sync-afb-conversions:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger AFB Sync API
        run: |
          echo "ğŸš€ Starting AFBæˆæœãƒ‡ãƒ¼ã‚¿åŒæœŸ..."

          # POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦AFB APIãƒãƒ¼ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s \
            "${{ secrets.APP_URL }}/api/cron/sync-afb-conversions")

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200ç³»ä»¥å¤–ãªã‚‰ã‚¨ãƒ©ãƒ¼
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "âŒ AFBåŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $http_code)"
            exit 1
          fi

          echo "âœ… AFBåŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ AFBæˆæœãƒ‡ãƒ¼ã‚¿åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          # å°†æ¥çš„ã«Slack/Discordé€šçŸ¥ã‚’è¿½åŠ å¯èƒ½
