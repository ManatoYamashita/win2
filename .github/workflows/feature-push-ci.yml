name: feature push CI

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'update/**'
      - 'refactor/**'
      - 'doc/**'
      - 'test/**'

jobs:
  test-and-pr:
    name: Build, Lint, Typecheck and PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Build
        run: pnpm build

      - name: Prepare PR body from template
        id: summary
        env:
          TARGET_BRANCH: dev
        run: |
          git fetch origin "${TARGET_BRANCH}"

          # PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          if [ -f ".github/pull_request_template.md" ]; then
            cat .github/pull_request_template.md > pr-body.md
          else
            echo "# Pull Request" > pr-body.md
            echo "" >> pr-body.md
            echo "## å¤‰æ›´å†…å®¹ã®æ¦‚è¦" >> pr-body.md
            echo "" >> pr-body.md
          fi

          # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æŒ¿å…¥
          echo "" >> pr-body.md
          echo "---" >> pr-body.md
          echo "" >> pr-body.md
          echo "## ðŸ“‹ ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰" >> pr-body.md
          echo "" >> pr-body.md

          if git rev-parse --verify "origin/${TARGET_BRANCH}" >/dev/null 2>&1; then
            LOG=$(git log "origin/${TARGET_BRANCH}..HEAD" --pretty=format:'- %s (%h)')
            if [ -z "$LOG" ]; then
              echo "- å¤‰æ›´ç‚¹ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >> pr-body.md
            else
              echo "$LOG" >> pr-body.md
            fi
          else
            echo "- origin/${TARGET_BRANCH} ãƒ–ãƒ©ãƒ³ãƒãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >> pr-body.md
          fi

          {
            echo "body<<EOF"
            cat pr-body.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create or update PR to dev
        if: success()
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ steps.summary.outputs.body }}
        with:
          github-token: ${{ secrets.DEV_PR_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = context.ref.replace('refs/heads/', '');

            // é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä¸€è¦§
            const allowedPrefixes = ['feature/', 'fix/', 'update/', 'refactor/', 'doc/', 'test/'];
            const isAllowedBranch = allowedPrefixes.some(prefix => headBranch.startsWith(prefix));

            if (!isAllowedBranch) {
              core.info(`Head branch ${headBranch} is not a development branch, skipping PR creation.`);
              return;
            }

            const body = process.env.PR_BODY || '# Pull Request\n\n## å¤‰æ›´å†…å®¹ã®æ¦‚è¦\n\n- å¤‰æ›´ç‚¹æƒ…å ±ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            const title = `[CI] ${headBranch} -> dev è‡ªå‹•PR`;

            const handleForbiddenError = (error) => {
              const message = (error && error.message) || '';
              const status = error && error.status;
              if (status === 403 && message.includes('not permitted to create or approve pull requests')) {
                const instructions = [
                  'GitHub ActionsãŒPRã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚æ¬¡ã®ã„ãšã‚Œã‹ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„:',
                  '1. ãƒªãƒã‚¸ãƒˆãƒªè¨­å®š > Actions > General > Workflow permissions ã§ "Allow GitHub Actions to create and approve pull requests" ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹',
                  '2. repoã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸Žã—ãŸPATã‚’ãƒªãƒã‚¸ãƒˆãƒªSecret `DEV_PR_TOKEN` ã¨ã—ã¦ç™»éŒ²ã™ã‚‹'
                ].join('\n');
                core.setFailed(instructions);
                return true;
              }
              return false;
            };

            try {
              const { data: existing } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${headBranch}`,
                base: 'dev',
                per_page: 1
              });

              if (existing.length > 0) {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: existing[0].number,
                  title,
                  body
                });
                core.setOutput('action', 'updated');
                core.setOutput('pull_number', existing[0].number);
              } else {
                const { data: pr } = await github.rest.pulls.create({
                  owner,
                  repo,
                  head: headBranch,
                  base: 'dev',
                  title,
                  body
                });
                core.setOutput('action', 'created');
                core.setOutput('pull_number', pr.number);
              }
            } catch (error) {
              if (!handleForbiddenError(error)) {
                throw error;
              }
            }
