name: feature push CI

on:
  push:
    branches:
      - 'feature/**'

jobs:
  test-and-pr:
    name: Build, Lint, Typecheck and PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npx tsc --noEmit

      - name: Prepare change summary
        id: summary
        env:
          TARGET_BRANCH: dev
        run: |
          git fetch origin "${TARGET_BRANCH}"
          echo "# featureブランチ差分概要" > pr-body.md
          echo "" >> pr-body.md
          if git rev-parse --verify "origin/${TARGET_BRANCH}" >/dev/null 2>&1; then
            LOG=$(git log "origin/${TARGET_BRANCH}..HEAD" --pretty=format:'- %s (%h)')
            if [ -z "$LOG" ]; then
              echo "- 変更点を特定できませんでした。" >> pr-body.md
            else
              echo "$LOG" >> pr-body.md
            fi
          else
            echo "- origin/${TARGET_BRANCH} ブランチが取得できませんでした。" >> pr-body.md
          fi
          {
            echo "body<<EOF"
            cat pr-body.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create or update PR to dev
        if: success()
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ steps.summary.outputs.body }}
        with:
          github-token: ${{ secrets.DEV_PR_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = context.ref.replace('refs/heads/', '');
            if (!headBranch.startsWith('feature/')) {
              core.info(`Head branch ${headBranch} is not feature/*, skipping PR creation.`);
              return;
            }
            const body = process.env.PR_BODY || '# featureブランチ差分概要\n\n- 変更点情報を生成できませんでした。';
            const title = `[CI] ${headBranch} -> dev 自動PR`;

            const handleForbiddenError = (error) => {
              const message = (error && error.message) || '';
              const status = error && error.status;
              if (status === 403 && message.includes('not permitted to create or approve pull requests')) {
                const instructions = [
                  'GitHub ActionsがPRを作成できません。次のいずれかを実施してください:',
                  '1. リポジトリ設定 > Actions > General > Workflow permissions で "Allow GitHub Actions to create and approve pull requests" を有効化する',
                  '2. repoスコープを付与したPATをリポジトリSecret `DEV_PR_TOKEN` として登録する'
                ].join('\n');
                core.setFailed(instructions);
                return true;
              }
              return false;
            };

            try {
              const { data: existing } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${headBranch}`,
                base: 'dev',
                per_page: 1
              });

              if (existing.length > 0) {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: existing[0].number,
                  title,
                  body
                });
                core.setOutput('action', 'updated');
                core.setOutput('pull_number', existing[0].number);
              } else {
                const { data: pr } = await github.rest.pulls.create({
                  owner,
                  repo,
                  head: headBranch,
                  base: 'dev',
                  title,
                  body
                });
                core.setOutput('action', 'created');
                core.setOutput('pull_number', pr.number);
              }
            } catch (error) {
              if (!handleForbiddenError(error)) {
                throw error;
              }
            }
