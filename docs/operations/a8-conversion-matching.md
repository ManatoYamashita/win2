# A8.net成果マッチング運用マニュアル

**最終更新**: 2025-11-15
**バージョン**: 1.0.0
**対象システム**: WIN×Ⅱ A8.net Parameter Tracking成果マッチング処理

## 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [Phase 1: 初回動作確認テスト](#phase-1-初回動作確認テスト)
4. [日常運用フロー](#日常運用フロー)
5. [トラブルシューティング](#トラブルシューティング)
6. [技術仕様](#技術仕様)

---

## 概要

### 目的

A8.net Parameter Tracking Reportから取得した成果データを、Google Sheets「クリックログ」シートに自動反映させ、各メンバーの申し込み案件とステータス（承認/未確定/否認）を記録します。

### 処理フロー

```
A8.net Parameter Tracking Report
  ↓ CSVダウンロード（手動、週1回）
Google Sheets「成果CSV_RAW」に貼り付け
  ↓ GASメニュー実行「成果をクリックログに記録」
GASがid1（会員ID）+ id2（イベントID）でマッチング
  ↓
「クリックログ」シートのF列・G列を自動更新
  ↓
メンバーがMyPageで確認可能
```

### 対象データ

- **クリックログ**: `/api/track-click` が記録したクリックデータ
- **成果CSV_RAW**: A8.net Parameter Tracking Reportから手動貼り付けした成果データ
- **マッチングキー**: id1（会員ID）+ id2（イベントID）の組み合わせ

---

## システム構成

### Google Sheetsシート構成

#### 1. クリックログ（`クリックログ`）

| 列 | 項目名 | データ例 | 更新方法 |
|---|---|---|---|
| A | 日時 | `2025年11月15日 12時34分56秒` | Next.js API |
| B | 会員ID | `b91765a2-f57d-4c82-bd07-9e0436f560da` | Next.js API |
| C | 案件名 | `楽天カード新規入会` | Next.js API |
| D | 案件ID | `a8-rakuten-card` | Next.js API |
| E | イベントID | `event-uuid-123` | Next.js API |
| **F** | **申し込み案件名** | `アンケートモニター【マクロミル】` | **GAS自動更新** |
| **G** | **STATUS** | `未確定` / `成果確定` / `否認` | **GAS自動更新** |

**重要**: F列・G列はNext.js APIでは記録されず、GAS処理で成果マッチング時に自動更新されます。

#### 2. 成果CSV_RAW（`成果CSV_RAW`）

A8.net Parameter Tracking Report CSVを**そのまま貼り付ける**シート。

**必須列**（ヘッダー行）:
- `パラメータ(ID1)`: 会員ID（memberId）
- `パラメータ(ID2)`: イベントID（eventId）
- `プログラム名`: 申し込まれた案件名
- `ステータス名`: 承認状況

**サンプルデータ**:

| パラメータ(ID1) | パラメータ(ID2) | プログラム名 | ステータス名 | 発生報酬額 |
|---|---|---|---|---|
| b91765a2-f57d-4c82-bd07-9e0436f560da | event-uuid-123 | アンケートモニター【マクロミル】 | 未確定 | 280 |
| guest:uuid-789 | event-uuid-456 | 三井住友カード | 成果確定 | 500 |

### GASスクリプト

- **ファイル名**: `google-spread-sheet/code.gs.js`
- **バージョン**: v4.0.0
- **関数名**: `recordConversionsToClickLog()`
- **実行方法**: メニュー「成果処理」→「成果をクリックログに記録」

---

## Phase 1: 初回動作確認テスト

### 目的

既存システムが正常に動作するか確認し、A8.net成果データがクリックログに反映されることを検証します。

### 所要時間

約10分

### 前提条件

1. Google Sheetsに以下のシートが存在する:
   - `クリックログ`
   - `成果CSV_RAW`
2. A8.net Media Memberアカウントでログイン済み
3. Parameter Tracking Report実行権限がある
4. 過去にクリックログが記録されている（`/api/track-click` が動作済み）

### テスト手順

#### Step 1: クリックログの確認

1. Google Sheetsを開く:
   - URL: [Google Sheetsスプレッドシート](https://docs.google.com/spreadsheets/d/1jZhmEp6HaK73GPYJmZhxOQyV5LvfDoqJQ9_s_sUZU5gt1YYe-CkgcP6q/edit)

2. 「クリックログ」シートを開く

3. **F列・G列が空白であることを確認**
   - F列（申し込み案件名）: 空白
   - G列（STATUS）: 空白

4. **既存クリックログを1件確認**
   - B列（会員ID）: UUID形式の値が記録されているか
   - E列（イベントID）: UUID形式の値が記録されているか
   - この値を後でマッチング確認に使用

#### Step 2: A8.net CSVダウンロード

1. A8.net管理画面にログイン:
   - URL: https://www.a8.net/

2. Parameter Tracking Reportにアクセス:
   - URL: https://media-console.a8.net/report/parameter

3. 検索条件を設定:
   - **期間**: 過去30日間（クリックログに記録があるデータを含む期間）
   - **パラメータ**: すべて（空白でOK）
   - **プログラム**: すべて

4. 「検索する」ボタンをクリック

5. **CSVダウンロード**:
   - ページ下部の「CSV出力」ボタンをクリック
   - ファイル名例: `parameter_20251101-20251115_20251115173805.csv`
   - ダウンロードフォルダに保存

#### Step 3: CSVをGoogle Sheetsに貼り付け

1. ダウンロードしたCSVファイルを開く（Excel、Numbers、テキストエディタなど）

2. **全データをコピー**:
   - ヘッダー行（1行目）を含めてすべて選択
   - Ctrl+C（Windows）/ Cmd+C（Mac）でコピー

3. Google Sheetsに戻る

4. 「成果CSV_RAW」シートを開く

5. **A1セルを選択**（左上の最初のセル）

6. **既存データを削除**（もしあれば）:
   - Ctrl+A（すべて選択）→ Delete

7. **貼り付け**:
   - Ctrl+V（Windows）/ Cmd+V（Mac）
   - 「書式なしで貼り付け」を推奨

8. **ヘッダー行を確認**:
   - 1行目に以下の列が含まれているか確認:
     - `パラメータ(ID1)`
     - `パラメータ(ID2)`
     - `プログラム名`
     - `ステータス名`

#### Step 4: GASスクリプト実行

1. Google Sheetsのメニューバーを確認

2. **「成果処理」メニューを探す**:
   - メニューバー: ファイル | 編集 | 表示 | ... | **成果処理**
   - もし「成果処理」メニューが表示されない場合:
     - ページをリロード（F5 / Cmd+R）
     - それでも表示されない場合は後述のトラブルシューティング参照

3. **「成果処理」メニューをクリック**

4. **「成果をクリックログに記録」を選択**

5. **初回実行時のみ**: 権限承認ダイアログが表示される場合
   - 「許可を確認」をクリック
   - Googleアカウント選択
   - 「詳細」→「（安全ではないページ）に移動」をクリック
   - 「許可」をクリック
   - 再度「成果処理」→「成果をクリックログに記録」を実行

6. **処理実行中**: 数秒～数十秒待機（データ量による）

7. **完了アラート**:
   - アラートボックスが表示される
   - 内容例:
     ```
     成果マッチング処理が完了しました

     成功: 5件
     失敗: 0件
     ```
   - 「OK」をクリック

#### Step 5: 結果確認

1. 「クリックログ」シートに戻る

2. **F列・G列が更新されているか確認**:
   - マッチングした行のF列に案件名が記録されている
   - マッチングした行のG列にステータスが記録されている

3. **具体例**:

| A（日時） | B（会員ID） | C（案件名） | D（案件ID） | E（イベントID） | **F（申し込み案件名）** | **G（STATUS）** |
|---|---|---|---|---|---|---|
| 2025年11月15日 16時35分23秒 | b91765a2-... | マクロミル | a8-macromill | event-uuid-123 | アンケートモニター【マクロミル】 | 未確定 |

4. **期待される結果**:
   - 成果CSV_RAWのデータとクリックログのデータが **id1（B列）+ id2（E列）** でマッチ
   - マッチした行のF列・G列が自動更新
   - マッチしなかった行はF列・G列が空白のまま

### テスト成功の判定

以下の条件をすべて満たせば成功:

✅ メニュー「成果処理」が表示される
✅ GAS実行でエラーが出ない
✅ 完了アラートに「成功: X件」と表示される
✅ クリックログのF列・G列が更新される
✅ 成果CSV_RAWのデータと対応している

### テスト失敗時

後述の「トラブルシューティング」セクションを参照してください。

---

## 日常運用フロー

### 実施頻度

**推奨**: 週1回（毎週月曜日など、定期的な曜日を設定）
**最低**: 月1回

### 所要時間

約5分/回

### 運用手順（簡易版）

1. **A8.net Parameter Tracking Reportにアクセス**
   - URL: https://media-console.a8.net/report/parameter
   - 期間: 前回実施日～本日
   - CSV出力

2. **Google Sheets「成果CSV_RAW」に貼り付け**
   - 既存データを削除
   - ヘッダー行含めて全データ貼り付け

3. **GAS実行**
   - メニュー「成果処理」→「成果をクリックログに記録」

4. **結果確認**
   - 完了アラートで成功件数を確認
   - クリックログシートでF列・G列が更新されたことを確認

5. **後処理**（オプション）
   - 成果CSV_RAWのデータをアーカイブ（別シートに移動）
   - または次回実行時に上書きでOK

### データ保存期間

- **A8.net Parameter Tracking Report**: 過去90日間のデータが検索可能
- **推奨**: 最低でも月1回は実行し、データを取り込む

### 処理タイミング

- **クリック発生**: リアルタイム（`/api/track-click` がクリックログに記録）
- **成果発生**: A8.net側でコンバージョン検知（数分～数時間）
- **成果反映**: 上記運用フロー実行時（週1回など）
- **ステータス確定**: A8.net側で承認処理後（数日～数週間）

**注意**: ステータスが「未確定」→「成果確定」に変わった場合、再度上記手順を実行することで最新ステータスに更新されます。

---

## トラブルシューティング

### 問題1: 「成果処理」メニューが表示されない

**症状**:
- Google Sheetsのメニューバーに「成果処理」メニューが表示されない

**原因**:
- GASスクリプトの `onOpen()` トリガーが実行されていない
- スプレッドシートの読み込みタイミングの問題

**対処法**:

1. **ページをリロード**:
   - F5（Windows）/ Cmd+R（Mac）
   - 数秒待ってメニューバーを確認

2. **GASエディタから手動実行**:
   - メニュー「拡張機能」→「Apps Script」をクリック
   - GASエディタが開く
   - 関数選択: `createCustomMenu` を選択
   - 「実行」ボタンをクリック
   - スプレッドシートに戻り、メニューを確認

3. **トリガーの確認**:
   - GASエディタ左側メニュー「トリガー」をクリック
   - `onOpen` トリガーが存在するか確認
   - 存在しない場合:
     - 「トリガーを追加」をクリック
     - 関数: `onOpen`
     - イベントソース: スプレッドシートから
     - イベントタイプ: 開いたとき
     - 「保存」をクリック

### 問題2: ヘッダーが検出できないエラー

**症状**:
- GAS実行時にアラート表示:
  ```
  エラー: id1（会員ID）カラムが見つかりません

  ヘッダー候補: パラメータ(id1), id1, memberid
  ```

**原因**:
- 成果CSV_RAWの1行目（ヘッダー行）に想定外の列名が使用されている
- A8.netのCSVフォーマットが変更された

**対処法**:

1. **ヘッダー行を確認**:
   - 成果CSV_RAWの1行目を確認
   - 会員IDに該当する列の正確な名前をメモ（例: `パラメータ(ID1)`）

2. **GASコードを更新**:
   - メニュー「拡張機能」→「Apps Script」
   - `code.gs.js` を開く
   - `HEADER_CANDIDATES` セクション（L24-38）を探す
   - 該当する配列に新しいヘッダー名を追加:
     ```javascript
     memberId: [
       'パラメータ(id1)',
       'パラメータid1',
       '新しいヘッダー名をここに追加', // ← 追加
       ...
     ],
     ```
   - 「保存」ボタンをクリック（Ctrl+S / Cmd+S）

3. **再実行**:
   - スプレッドシートに戻る
   - メニュー「成果処理」→「成果をクリックログに記録」を再実行

### 問題3: マッチングが失敗する（成功: 0件）

**症状**:
- GAS実行後のアラート:
  ```
  成果マッチング処理が完了しました

  成功: 0件
  失敗: 5件
  ```

**原因**:
- 成果CSV_RAWのid1またはid2の値が、クリックログのB列・E列と一致しない
- クリックログにそもそもデータが記録されていない

**対処法**:

1. **データの存在確認**:
   - クリックログシートを開く
   - B列（会員ID）とE列（イベントID）にデータが記録されているか確認
   - データがない場合: `/api/track-click` が正常に動作していない可能性

2. **値の比較**:
   - 成果CSV_RAWのA列（id1）の値をコピー
   - クリックログシートでCtrl+F（検索）
   - B列に同じ値が存在するか確認
   - 存在する場合: 次にE列とid2を比較

3. **トリミング確認**:
   - 値の前後に **余計なスペース** がないか確認
   - Excel/Numbersでコピーした場合、改行コードが含まれることがある
   - テキストエディタで確認し、余計な文字を削除

4. **id2が「-」の場合**:
   - A8.net CSVで `パラメータ(ID2)` が「-」（ハイフン）の場合、マッチングできません
   - これは正常な動作です（id2なしのクリックはマッチング対象外）

### 問題4: F列・G列が更新されない

**症状**:
- GAS実行後、アラートは「成功: 5件」と表示される
- しかしクリックログのF列・G列が空白のまま

**原因**:
- GASコードの列番号が間違っている
- シート構造が変更された

**対処法**:

1. **列番号の確認**:
   - メニュー「拡張機能」→「Apps Script」
   - `code.gs.js` のL142-143を確認:
     ```javascript
     clickLogSheet.getRange(matchedRowIndex + 1, 6).setValue(dealName);  // 6 = F列
     clickLogSheet.getRange(matchedRowIndex + 1, 7).setValue(status);    // 7 = G列
     ```
   - クリックログシートのF列が6列目、G列が7列目であることを確認
   - もし列構成が異なる場合、数値を調整

2. **GAS実行ログを確認**:
   - GASエディタで「表示」→「ログ」をクリック
   - エラーメッセージが出ていないか確認

3. **手動テスト**:
   - GASエディタで `recordConversionsToClickLog()` 関数を選択
   - 「実行」ボタンをクリック
   - ログにエラーが表示されるか確認

### 問題5: 権限エラー

**症状**:
- GAS実行時に「権限が必要です」というエラー

**対処法**:

1. **認証フローの再実行**:
   - GASエディタで関数を実行
   - 「許可を確認」をクリック
   - Googleアカウント選択
   - 「詳細」→「（安全ではないページ）に移動」
   - 必要な権限を確認し「許可」

2. **スプレッドシート共有設定**:
   - スプレッドシートの「共有」ボタンをクリック
   - 自分のGoogleアカウントに「編集権限」があるか確認

---

## 技術仕様

### マッチングアルゴリズム

**処理フロー**（`code.gs.js` L117-147）:

```javascript
// 成果CSV_RAWの各行をループ
for (let i = 1; i < rawValues.length; i++) {
  const row = rawValues[i];

  // id1（会員ID）とid2（イベントID）を抽出
  const memberId = safeCell_(row[col.memberId]);
  const eventId = safeCell_(row[col.eventId]);

  // クリックログから該当行を検索
  for (let j = 1; j < clickLogValues.length; j++) {
    const clickRow = clickLogValues[j];
    const clickMemberId = safeCell_(clickRow[1]); // B列
    const clickEventId = safeCell_(clickRow[4]);  // E列

    // 完全一致検索
    if (clickMemberId === memberId && clickEventId === eventId) {
      // マッチング成功 → F列・G列を更新
      clickLogSheet.getRange(j + 1, 6).setValue(dealName);  // F列
      clickLogSheet.getRange(j + 1, 7).setValue(status);    // G列
      break;
    }
  }
}
```

**マッチング条件**:
- **B列（会員ID）= A8.netのパラメータ(ID1)** かつ
- **E列（イベントID）= A8.netのパラメータ(ID2)**
- 両方が **完全一致**（大文字小文字区別あり）
- トリミング処理あり（前後のスペース削除）

**計算量**:
- 時間複雑度: O(n × m)
  - n: 成果CSV_RAWの行数
  - m: クリックログの行数
- 想定規模: n=10～100件、m=1,000～10,000件
- 実行時間: 数秒～数十秒

### ヘッダー検出ロジック

**柔軟な検出**（`code.gs.js` L179-199）:

```javascript
const HEADER_CANDIDATES = {
  memberId: [
    'パラメータ(id1)', 'パラメータid1', 'パラメータ（id1）',
    'パラメータ（ID1）', 'パラメータID1', 'id1', 'ID1', ...
  ],
  eventId: [
    'パラメータ(id2)', 'パラメータid2', 'パラメータ（id2）', ...
  ],
  dealName: [
    'プログラム名', '案件名', '商品名', '広告名', ...
  ],
  status: [
    'ステータス名', '承認状況', 'ステータス', '状態', ...
  ]
};
```

**検出アルゴリズム**:
1. ヘッダー文字列を正規化（小文字化、記号除去、スペース削除）
2. 完全一致検索（正規化後）
3. 部分一致検索（正規化後）
4. 最初にマッチしたものを採用

### データフォーマット

**クリックログ（Next.js API記録時）**:

```typescript
{
  timestamp: "2025年11月15日 16時35分23秒",  // formatJapaneseDateTime()
  memberId: "b91765a2-f57d-4c82-bd07-9e0436f560da",  // UUID v4
  dealName: "マクロミル新規登録",
  dealId: "a8-macromill",
  eventId: "event-uuid-123"  // crypto.randomUUID()
}
```

**A8.net Parameter Tracking Report CSV**:

```csv
プログラムID,プログラム名,パラメータ(ID1),パラメータ(ID2),ステータス名,発生報酬額,...
s00000013554002,アンケートモニター【マクロミル】,b91765a2-...,event-uuid-123,未確定,280,...
```

### エラーハンドリング

**GASのエラーチェック**:

1. **シート存在チェック**（L64-71）
2. **必須カラムチェック**（L89-97）
3. **マッチング結果の集計**（L123, L147）
4. **アラート表示**（L154-166）:
   - 失敗が10件以下: 詳細表示
   - 失敗が10件以上: 件数のみ表示
   - 全件成功: サマリーのみ

### パフォーマンス最適化（将来検討）

**現在の実装**: 全行読み込み + ネストループ（O(n×m)）

**改善案**:
1. **Map構造でインデックス化**:
   ```javascript
   const clickLogMap = new Map();
   for (const row of clickLogValues) {
     const key = `${row[1]}-${row[4]}`; // memberId-eventId
     clickLogMap.set(key, row);
   }
   ```
   - 時間複雑度: O(n + m)
   - メモリ: O(m)

2. **バッチ更新API**:
   - `setValues()` を使用して一括更新
   - 現在: 行単位更新（`setValue()`）

3. **差分更新**:
   - 既にF列・G列に値がある行はスキップ
   - 新規マッチングのみ処理

---

## 付録

### 関連ドキュメント

- **システム仕様**: `docs/specs/spec.md`
- **Google Sheets仕様**: `docs/specs/google.md`
- **GASコード**: `google-spread-sheet/code.gs.js`
- **Next.js API**: `app/api/track-click/route.ts`
- **ハイブリッド運用**: `docs/operations/afb-a8-hybrid-workflow.md`

### GASエディタURL

- [Google Apps Scriptエディタ](https://script.google.com/d/1jZhmEp6HaK73GPYJmZhxOQyV5LvfDoqJQ9_s_sUZU5gt1YYe-CkgcP6q/edit)

### よくある質問（FAQ）

**Q1: 同じ成果データを複数回実行するとどうなりますか？**

A1: 同じid1+id2の組み合わせに対して、F列・G列が上書き更新されます。重複処理は発生しません。

**Q2: ステータスが「未確定」から「成果確定」に変わった場合、どうすればいいですか？**

A2: 最新のParameter Tracking Report CSVを再度ダウンロードし、同じ手順で処理を実行してください。ステータスが最新の値に更新されます。

**Q3: id2（イベントID）が「-」の成果はマッチングできますか？**

A3: できません。WIN×Ⅱシステムでは、id1+id2の両方が必要です。id2なしのコンバージョンは、他のトラッキング方法（Cookieベースなど）で発生した可能性があります。

**Q4: 成果CSV_RAWのデータは削除してもいいですか？**

A4: 次回実行時に上書きするため、削除しても問題ありません。ただし、履歴として残したい場合は、別シートにアーカイブすることを推奨します。

**Q5: 処理を自動化できますか？**

A5: 技術的には可能ですが、A8.net CSVの手動ダウンロードが必要なため、完全自動化はできません。GAS実行のみトリガー化することは可能です（例: 毎週月曜9時に自動実行）。

---

**最終更新**: 2025-11-15
**作成者**: Claude Code
**メンテナンス**: 必要に応じて更新
