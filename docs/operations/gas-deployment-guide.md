# GAS（Google Apps Script）デプロイガイド

## 概要

このガイドでは、Rentracksトラッキング対応のGASコード（v4.1.0）をGoogle Sheetsにデプロイする手順を説明します。

## 前提条件

- Google Sheetsの編集権限があること
- リポジトリの最新コード（`google-spread-sheet/code.gs.js`）にアクセスできること

## デプロイ手順

### ステップ1: Google Sheetsを開く

1. Google Sheetsのマスタースプレッドシートを開く
2. シート名を確認:
   - ✅ `成果CSV_RAW`
   - ✅ `クリックログ`

### ステップ2: Apps Scriptエディタを開く

1. メニューバーから「拡張機能」→「Apps Script」をクリック
2. 新しいタブでGASエディタが開きます

### ステップ3: コードを更新

1. GASエディタ左側のファイルツリーで `Code.gs` を選択
2. リポジトリの `google-spread-sheet/code.gs.js` を開く
3. **全内容をコピー**（Ctrl+A → Ctrl+C / Cmd+A → Cmd+C）
4. GASエディタに**貼り付け**（既存コードを全て置き換え）
5. **保存**（Ctrl+S / Cmd+S）

### ステップ4: デプロイ確認

1. GASエディタ上部の「保存」アイコンが灰色になることを確認（保存完了）
2. Google Sheetsに戻る
3. メニューバーを確認:
   - ✅ 「成果処理」メニューが表示されていること
   - ✅ サブメニュー「成果をクリックログに記録」が表示されていること

### ステップ5: 初回実行（権限承認）

1. メニュー「成果処理」→「成果をクリックログに記録」をクリック
2. 初回実行時、権限承認ダイアログが表示されます
3. 「続行」→ Google アカウント選択 → 「許可」をクリック
4. 承認完了後、再度メニューから実行

## v4.1.0の変更点（Rentracks対応）

### 1. HEADER_CANDIDATES拡張

**追加されたヘッダー候補**:

- **memberId/eventId**: `'uix'`, `'備考'`, `'remarks'`, `'note'`, `'memo'`
- **dealName**: `'プロダクト'`, `'product'`
- **status**: `'状況'`, `'situation'`, `'approval_status'`

### 2. uix分割処理

**処理内容**:

- Rentracks「注文リスト」CSVの「備考」列に記録されたuix値（`{memberId}-{eventId}`形式）を自動分割
- UUID v4形式（5パーツ）を検証
- `guest:UUID`形式にも対応

**分割例**:

```javascript
// 入力（備考列）
"b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123"

// 分割結果
memberId: "b91765a2-f57d-4c82-bd07-9e0436f560da"
eventId: "event-uuid-123"
```

### 3. 下位互換性

- ✅ A8.net Parameter Tracking Report CSVの処理は既存処理を維持
- ✅ Rentracks CSVとA8.net CSVの両方に対応

## トラブルシューティング

### メニュー「成果処理」が表示されない

**原因**: スクリプトの保存が完了していない、またはシートを再読み込みしていない

**解決策**:

1. GASエディタで保存を確認（Ctrl+S / Cmd+S）
2. Google Sheetsをリロード（F5 / Cmd+R）
3. メニューが表示されるまで数秒待つ

### 「成果CSV_RAWにデータがありません」エラー

**原因**: 「成果CSV_RAW」シートにヘッダー行のみ、またはデータ行が0行

**解決策**:

1. RentracksまたはA8.netからCSVをダウンロード
2. 「成果CSV_RAW」シートにヘッダー行を含めて貼り付け
3. 再度メニューから実行

### 「id1（会員ID）カラムが見つかりません」エラー

**原因**: CSVヘッダーがHEADER_CANDIDATESの候補と一致しない

**解決策**:

1. CSVの1行目（ヘッダー行）を確認
2. A8.netの場合: `パラメータ(id1)` または `パラメータ(ID1)` があることを確認
3. Rentracksの場合: `備考` または `uix` があることを確認
4. ヘッダー名が異なる場合、GASコードの `HEADER_CANDIDATES` に追加

### uix分割失敗（パーツ不足）

**原因**: 備考列のuix値が正しいUUID v4形式でない

**解決策**:

1. `/api/track-click` のログを確認（uix値が正しく生成されているか）
2. Rentracks管理画面で「備考」列の値を確認
3. uixパラメータが正しくアフィリエイトURLに付与されているか確認

## テスト実行（サンプルデータ）

### Rentracks CSVサンプル

「成果CSV_RAW」シートに以下をコピー＆ペースト:

```
クリック日時,売り上げ日時,売り上げ番号,広告主,プロダクト,売上額,報酬額,状況,期限,承認日,備考
2025-12-04 10:00:00,2025-12-04 11:00:00,12345,テスト広告主,サンプル商品A,10000,1000,承認,2025-12-31,2025-12-10,b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123
```

### 期待される結果

1. メニュー「成果処理」→「成果をクリックログに記録」実行
2. 完了アラート: 「成功: 1件、失敗: 0件」
3. クリックログシート確認:
   - B列（会員ID）: `b91765a2-f57d-4c82-bd07-9e0436f560da`
   - E列（イベントID）: `event-uuid-123`
   - F列（申し込み案件名）: `サンプル商品A`
   - G列（ステータス）: `承認`

## 次のステップ

1. ✅ GASコードデプロイ完了
2. ⏸️ Rentracks「注文リスト」CSVダウンロード（週1回運用）
3. ⏸️ 成果CSV_RAWにCSV貼り付け
4. ⏸️ GASスクリプト実行
5. ⏸️ クリックログF/G列更新確認

## 関連ドキュメント

- **プランファイル**: `.claude/plans/quirky-snuggling-hamming.md`
- **GASソースコード**: `google-spread-sheet/code.gs.js`
- **Rentracks仕様**: プランファイル「技術仕様」セクション

---

**バージョン**: v4.1.0（Rentracks対応）
**最終更新**: 2025-12-04
**作成者**: Claude Code
