# Rentracks成果マッチング運用マニュアル

## 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [週1回の運用フロー（5分）](#週1回の運用フロー5分)
4. [詳細手順](#詳細手順)
5. [トラブルシューティング](#トラブルシューティング)
6. [技術仕様](#技術仕様)
7. [FAQ](#faq)

---

## 概要

このマニュアルは、Rentracks（レントラックス）アフィリエイトの成果データをWIN×Ⅱシステムに記録し、会員のマイページに表示するための運用手順を説明します。

### システムフロー

```
会員が案件クリック
  ↓
WIN×Ⅱ /api/track-click
  ↓
Google Sheets「クリックログ」記録
  ↓
Rentracksアフィリエイトリンク（uixパラメータ付き）
  ↓
成果発生
  ↓
Rentracks「注文リスト」CSV
  ↓
【週1回運用】CSV手動ダウンロード＆Google Sheets貼り付け
  ↓
GASスクリプト実行（uix分割 → クリックログマッチング）
  ↓
会員マイページに成果表示
```

### A8.netとの違い

| 項目 | A8.net | Rentracks |
|------|--------|-----------|
| トラッキングパラメータ | `id1`, `id2`, `eventId` | `uix` |
| パラメータ形式 | 別々 | 結合（`{memberId}-{eventId}`） |
| CSV列名 | `パラメータ(id1)`, `パラメータ(id2)` | `備考` |
| GAS処理 | そのままマッチング | uix分割 → マッチング |

---

## 前提条件

### 1. 必要なアクセス権限

- ✅ Rentracks管理画面へのログイン権限
- ✅ Google Sheetsの編集権限
- ✅ GASスクリプトの実行権限

### 2. 事前設定完了項目

- ✅ WIN×Ⅱ `/api/track-click` デプロイ済み（Vercel）
- ✅ GAS v4.1.0 デプロイ済み（Google Sheets）
- ✅ Rentracks案件が「案件マスタ」シートに登録済み
- ✅ アフィリエイトURLに `uix` パラメータ設定済み

### 3. 確認事項

Google Sheetsに以下のシートが存在すること:

- ✅ `成果CSV_RAW` - CSV貼り付け用シート
- ✅ `クリックログ` - クリック記録とマッチング結果シート
- ✅ `案件マスタ` - Rentracks案件情報シート

---

## 週1回の運用フロー（5分）

### 実施タイミング

- **推奨**: 毎週月曜日 午前10時
- **所要時間**: 約5分
- **頻度**: 週1回（成果発生状況に応じて調整可）

### クイックステップ

1. **Rentracks管理画面ログイン** → 注文リスト表示
2. **CSVダウンロード** → 期間設定（前回実施日〜本日）
3. **Google Sheets「成果CSV_RAW」開く** → 既存データ削除
4. **CSV貼り付け** → A1セルにヘッダー行含めて貼り付け
5. **GASスクリプト実行** → メニュー「成果処理」→「成果をクリックログに記録」
6. **結果確認** → 完了アラート確認、クリックログF/G列更新確認

---

## 詳細手順

### ステップ1: Rentracks管理画面ログイン

1. Rentracks管理画面にアクセス: https://www.rentracks.jp/
2. メディアアカウントでログイン
3. ログイン後、ダッシュボードが表示される

### ステップ2: 注文リストCSVダウンロード

#### 2-1. レポート画面へ移動

1. 左側メニューから「レポート」をクリック
2. サブメニューから「注文リスト」を選択

#### 2-2. 期間設定

1. 「期間設定」フィールドで以下を入力:
   - **開始日**: 前回CSV処理を実施した日付
   - **終了日**: 本日の日付
2. 「検索」ボタンをクリック

> **💡 ヒント**: 初回実施時は過去1ヶ月分を指定することを推奨

#### 2-3. CSVエクスポート

1. 検索結果が表示される
2. 画面上部の「CSVエクスポート」ボタンをクリック
3. ダウンロードフォルダに `order_list_YYYYMMDD.csv` が保存される

> **📸 スクリーンショット位置**: Rentracks注文リスト画面、CSVエクスポートボタン

### ステップ3: Google Sheetsに貼り付け

#### 3-1. Google Sheetsを開く

1. Google Sheetsのマスタースプレッドシートを開く
2. 「成果CSV_RAW」シートタブをクリック

#### 3-2. 既存データ削除

1. シート内のデータを全選択（Ctrl+A / Cmd+A）
2. Delete キーで削除

> **⚠️ 注意**: A1セルから貼り付けるため、既存データは必ず削除してください

#### 3-3. CSV貼り付け

1. ダウンロードしたCSVファイルをExcelまたはテキストエディタで開く
2. **ヘッダー行を含めて全選択**（Ctrl+A / Cmd+A）
3. コピー（Ctrl+C / Cmd+C）
4. Google Sheets「成果CSV_RAW」シートのA1セルをクリック
5. 貼り付け（Ctrl+V / Cmd+V）

> **✅ 確認**: A1セルに「クリック日時」などのヘッダーが表示されていることを確認

### ステップ4: GASスクリプト実行

#### 4-1. メニューから実行

1. Google Sheetsメニューバーの「成果処理」をクリック
2. サブメニュー「成果をクリックログに記録」をクリック

> **⏱️ 処理時間**: データ件数により1〜30秒程度

#### 4-2. 実行結果確認

実行完了後、以下のアラートが表示されます:

```
成果マッチング処理完了

成功: XX件
失敗: XX件
```

> **✅ 正常**: 失敗が0件、または数件程度
> **⚠️ 警告**: 失敗が多数（全体の30%以上）の場合、トラブルシューティングセクションを参照

### ステップ5: 結果確認

#### 5-1. クリックログシート確認

1. 「クリックログ」シートタブをクリック
2. 最新行を確認:
   - **F列（申し込み案件名）**: Rentracks案件名が記録されているか
   - **G列（ステータス）**: 「承認」「保留」「拒否」などが記録されているか

#### 5-2. マイページ確認（オプション）

1. WIN×Ⅱマイページにアクセス
2. 成果履歴ページで最新の成果が表示されているか確認

---

## トラブルシューティング

### 1. 「成果CSV_RAWにデータがありません」エラー

**症状**: GAS実行時に警告アラートが表示される

**原因**:
- CSV貼り付けが完了していない
- ヘッダー行のみでデータ行が0行
- A1セル以外に貼り付けた

**解決策**:
1. 「成果CSV_RAW」シートを確認
2. A1セルから貼り付けられているか確認
3. 2行目以降にデータ行があるか確認
4. 再度CSV貼り付けからやり直し

---

### 2. 「id1（会員ID）カラムが見つかりません」エラー

**症状**: GAS実行時にエラーアラートが表示される

**原因**:
- CSVヘッダー列名がHEADER_CANDIDATESの候補と一致しない
- CSV形式が異なる（Rentracks以外のCSVを貼り付けた）

**解決策**:

1. CSVの1行目（ヘッダー行）を確認:
   ```
   クリック日時,売り上げ日時,売り上げ番号,広告主,プロダクト,売上額,報酬額,状況,期限,承認日,備考
   ```
2. 「備考」列があることを確認
3. Rentracksの「注文リスト」CSVをダウンロードしたか確認
4. 他のレポート（例: クリックレポート）を誤ってダウンロードした場合、注文リストを再ダウンロード

**GAS HEADER_CANDIDATES（Rentracks用）**:
- memberId: `'uix'`, `'備考'`, `'remarks'`, `'note'`, `'memo'`
- dealName: `'プロダクト'`, `'product'`
- status: `'状況'`, `'situation'`, `'approval_status'`

---

### 3. uix分割失敗（パーツ不足）

**症状**: GAS実行ログに `[warn] uix分割失敗（パーツ不足）` が表示される

**原因**:
- 備考列のuix値が正しいUUID v4形式でない
- uixパラメータが正しくアフィリエイトURLに付与されていない
- Rentracks側でuixパラメータが記録されていない

**解決策**:

1. **uix値の形式確認**:
   - 正常: `b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123`
   - 異常: `member-12345`（パーツ数不足）

2. **/api/track-click のログ確認**（開発者向け）:
   ```bash
   # Vercelログで確認
   [track-click] Rentracks URL generated: {
     uix: "guest:c90f71cf-45d6-4907-bcd3-596a4de45e50-c67b8bfc-a3e2-4e29-a3bd-bbcccc0517f6"
   }
   ```

3. **Rentracks設定確認**:
   - アフィリエイトURLに `&uix=...` が付与されているか確認
   - Rentracks側でuixパラメータが有効化されているか担当者に確認

---

### 4. マッチング失敗（成功: 0件、失敗: XX件）

**症状**: GAS実行後、失敗件数が多数

**原因**:
- クリックログシートに該当するクリック記録が存在しない
- memberId または eventId が一致しない
- 成果発生日がクリック記録より前

**解決策**:

1. **クリックログシート確認**:
   - B列（会員ID）とE列（イベントID）を確認
   - 成果CSV_RAWの備考列と照合

2. **照合例**:
   ```
   成果CSV_RAW 備考列: b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123
   ↓ uix分割
   memberId: b91765a2-f57d-4c82-bd07-9e0436f560da
   eventId: event-uuid-123
   ↓ クリックログ照合
   B列: b91765a2-f57d-4c82-bd07-9e0436f560da ✅
   E列: event-uuid-123 ✅
   ```

3. **クリック記録がない場合**:
   - 成果発生前に会員がクリックした記録があるか確認
   - /api/track-click が正常に動作しているか確認
   - Google Sheetsへの書き込み権限があるか確認

---

### 5. 「クリックログにデータがありません」警告

**症状**: GAS実行時に警告アラートが表示される

**原因**:
- クリックログシートにヘッダー行しかない
- 会員がまだ案件をクリックしていない

**解決策**:

1. クリックログシートを確認
2. 2行目以降にクリック記録があるか確認
3. クリック記録がない場合:
   - テスト環境でRentracks案件のCTAボタンをクリック
   - クリックログシートに記録されるか確認
   - /api/track-click のログを確認

---

### 6. id1とid2が同じ値になる（v4.3.1で修正済み）

**症状**: GAS実行後、全成果が失敗し、失敗ログで id1 と id2 が同じ値を表示

```
成功: 0件
失敗: 4件

【失敗した成果】
id1=0f23d556-348a-4da7-b18d-311ed5b3fd81-4a501767-adf9-49d2-8051-e1db3b671de8
id2=0f23d556-348a-4da7-b18d-311ed5b3fd81-4a501767-adf9-49d2-8051-e1db3b671de8
```

**原因（v4.3.0以前のバグ）**:

- HEADER_CANDIDATES.eventId に `'uix'`, `'備考'` が重複して含まれていた
- `findColIdx_()` が Rentracks CSV の「備考」列を memberId と eventId の両方で検出
- 両変数が同じ列を指すため、uix 分割処理が実行されなかった

**修正内容（v4.3.1）**:

- HEADER_CANDIDATES.eventId から `'uix'`, `'備考'`, `'remarks'`, `'note'`, `'memo'` を削除
- これらのヘッダー候補は memberId 専用として維持
- eventId は A8.net の `パラメータ(ID2)` 専用として動作

**解決策**:

1. **GASコード更新**（v4.3.1以降）:
   - `google-spread-sheet/code.gs.js` を最新版に更新
   - v4.3.1 以降であれば自動的に修正済み

2. **動作確認**:
   - Rentracks CSVを再度「成果CSV_RAW」に貼り付け
   - GASメニュー実行
   - 成功件数が増加することを確認

3. **バージョン確認方法**:
   - GASエディタを開く
   - コード先頭のコメントで `v4.3.1` 以降であることを確認
   - 見つからない場合は `docs/operations/gas-deployment-guide.md` に従ってコード更新

---

## 技術仕様

### uixパラメータ形式

Rentracksアフィリエイトリンクに付与されるトラッキングパラメータ:

```
形式: {memberId}-{eventId}
例: b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123
文字数: 約73文字（Rentracks制限512文字内）
```

**構成要素**:
- `memberId`: 会員UUID v4（36文字）または `guest:UUID`（42文字）
- ハイフン: 1文字（区切り文字）
- `eventId`: イベントUUID v4（36文字）

### Rentracks「注文リスト」CSV構造

```csv
クリック日時,売り上げ日時,売り上げ番号,広告主,プロダクト,売上額,報酬額,状況,期限,承認日,備考,...
2025-12-04 10:00:00,2025-12-04 11:00:00,12345,テスト広告主,サンプル商品A,10000,1000,承認,2025-12-31,2025-12-10,b91765a2-f57d-4c82-bd07-9e0436f560da-event-uuid-123,...
```

**重要カラム**:
- **備考**: uix値（`{memberId}-{eventId}`）
- **プロダクト**: 案件名
- **状況**: ステータス（承認/保留/拒否）※一部CSVでは使用されない場合あり
- **承認済件数**: ステータス（0/1の数値形式）※GAS v4.3.0で自動変換（0→"未確定", 1→"確定"）
- **報酬額**: 成果報酬金額

**CSVの「承認済件数」列の扱い** (v4.3.0対応):
- Rentracks CSVの「承認済件数」列は0/1の数値で記録されています
- GASが自動的にステータス文字列に変換します:
  - **0 → "未確定"** (成果が発生したが承認待ちの状態)
  - **1 → "確定"** (成果が承認され、報酬が確定した状態)
- クリックログのG列には変換後の文字列が記録されます

### GAS処理フロー

```javascript
// 1. CSV読み込み
const rawValues = rawSheet.getDataRange().getValues();

// 2. ヘッダー検出
const col = {
  memberId: findColIdx_(header, HEADER_CANDIDATES.memberId),  // '備考' 列
  eventId: findColIdx_(header, HEADER_CANDIDATES.eventId),    // '備考' 列（同じ）
  dealName: findColIdx_(header, HEADER_CANDIDATES.dealName),  // 'プロダクト' 列
  status: findColIdx_(header, HEADER_CANDIDATES.status)       // '状況' 列
};

// 3. 各行について処理
for (let i = 1; i < rawValues.length; i++) {
  let memberId = safeCell_(row[col.memberId]);  // 備考列から取得
  let eventId = safeCell_(row[col.eventId]);    // 備考列から取得（空）

  // 4. uix分割処理
  if (memberId.includes('-') && (!eventId || eventId === '')) {
    const parts = memberId.split('-');
    if (parts.length > 5) {
      memberId = parts.slice(0, 5).join('-');  // 最初の5パーツ
      eventId = parts.slice(5).join('-');      // 残りのパーツ
    }
  }

  // 5. クリックログからマッチング
  for (let j = 1; j < clickLogValues.length; j++) {
    const clickMemberId = safeCell_(clickRow[1]);  // B列
    const clickEventId = safeCell_(clickRow[4]);   // E列

    if (clickMemberId === memberId && clickEventId === eventId) {
      // 6. F/G列を更新
      clickLogSheet.getRange(j + 1, 6).setValue(dealName);  // F列（案件名）
      clickLogSheet.getRange(j + 1, 7).setValue(status);    // G列（ステータス）
      matched++;
      break;
    }
  }
}
```

### クリックログシート構造

```
A列: 日時                     | 2025-12-04 10時00分00秒
B列: 会員ID (id1)             | b91765a2-f57d-4c82-bd07-9e0436f560da
C列: 案件名                   | Rentracksテスト案件
D列: 案件ID                   | rentracks-test-001
E列: イベントID (id2)         | event-uuid-123
F列: 申し込み案件名 (GAS更新) | サンプル商品A
G列: ステータス (GAS更新)     | 承認
H列: ASP名 (GAS更新)          | Rentracks
```

---

## FAQ

### Q1. A8.net CSVとRentracks CSVを同時に処理できますか？

**A**: いいえ、別々に処理してください。

**理由**: 「成果CSV_RAW」シートは1つのASPのCSVのみ処理できます。

**推奨運用**:
1. A8.net CSVを貼り付け → GAS実行
2. Rentracks CSVを貼り付け → GAS実行

---

### Q2. 成果CSV_RAWシートは自動でクリアされますか？

**A**: いいえ、手動でクリアする必要があります。

**理由**: 前回のデータが残っていると重複処理される可能性があります。

**推奨運用**: CSV貼り付け前に必ず Ctrl+A → Delete でクリアしてください。

---

### Q3. 成果発生から何日以内にCSV処理すべきですか？

**A**: 特に期限はありませんが、週1回の定期処理を推奨します。

**理由**:
- クリックログは無期限保存されるため、過去の成果も遡ってマッチング可能
- ただし、会員への情報提供タイミングを考慮すると週1回が適切

---

### Q4. guest:UUIDの成果はどう扱われますか？

**A**: クリックログにguest:UUIDとして記録され、正常にマッチングされます。

**処理例**:
```
備考列: guest:c90f71cf-45d6-4907-bcd3-596a4de45e50-event-uuid-123
↓ uix分割
memberId: guest:c90f71cf-45d6-4907-bcd3-596a4de45e50
eventId: event-uuid-123
↓ クリックログ照合
B列: guest:c90f71cf-45d6-4907-bcd3-596a4de45e50 ✅
E列: event-uuid-123 ✅
```

**マイページ表示**: guest:UUIDの成果は「非会員」として表示されます。

---

### Q5. 失敗した成果は後から再処理できますか？

**A**: はい、可能です。

**方法**:
1. 「成果CSV_RAW」シートに失敗した成果データを再度貼り付け
2. GASスクリプトを再実行

**注意**: 既にF/G列が更新されている行は上書きされます。

---

### Q6. GASスクリプトの実行頻度制限はありますか？

**A**: Google Apps Scriptの実行制限内であれば制限なし。

**制限内容**:
- 1日あたりの実行時間: 90分（無料アカウント）
- 1回の実行時間: 6分

**実用上の制約**: 数千件規模のCSV処理でも数秒〜数十秒で完了するため、制限に達することはありません。

---

### Q7. Rentracks案件が複数ある場合、どう識別されますか？

**A**: クリックログのD列（案件ID）で識別されます。

**識別フロー**:
1. 会員がRentracks案件A（dealId: `rentracks-card-001`）をクリック
2. クリックログにD列 = `rentracks-card-001` として記録
3. Rentracks CSVのF列（案件名）がクリックログF列に記録
4. マイページで案件名とステータスを表示

---

### Q8. uix分割が失敗した成果はどうなりますか？

**A**: 失敗件数としてカウントされ、クリックログF/G列は更新されません。

**対処法**:
1. GAS実行ログを確認（Apps Script エディタ → 実行ログ）
2. 該当行の備考列を確認
3. /api/track-click のログを確認してuix生成が正常か確認
4. 必要に応じて開発者に報告

---

## 関連ドキュメント

- **GASデプロイガイド**: `docs/operations/gas-deployment-guide.md`
- **GASソースコード**: `google-spread-sheet/code.gs.js`
- **プランファイル**: `.claude/plans/quirky-snuggling-hamming.md`
- **API仕様**: `app/api/track-click/route.ts`

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0.0 | 2025-12-04 | 初版作成（Rentracks対応） |

---

**作成者**: Claude Code
**最終更新**: 2025-12-04
**対象バージョン**: GAS v4.1.0, /api/track-click v2.0.0
