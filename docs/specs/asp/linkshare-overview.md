# LinkShare (楽天アフィリエイト) API - 概要

**最終更新日:** 2025-01-04
**実装優先度:** Phase 4（20点/40点）
**実装ステータス:** ⏸️ 保留中

---

## 目次

1. [LinkShareとは](#linkshareとは)
2. [WIN×ⅡでのLinkShare統合目的](#winⅱでのlinkshare統合目的)
3. [利用可能なAPI機能](#利用可能なapi機能)
4. [カスタムトラッキングパラメータ](#カスタムトラッキングパラメータ)
5. [評価スコア詳細](#評価スコア詳細)
6. [実装時の注意点](#実装時の注意点)
7. [参考リンク](#参考リンク)

---

## LinkShareとは

### サービス概要

**LinkShare（リンクシェア）** は、楽天グループが運営するアフィリエイトサービスで、以下の特徴があります：

- **運営会社:** 楽天グループ株式会社
- **特徴:** 楽天市場の商品を中心に、大手企業の案件多数
- **強み:** 楽天エコシステムとの連携、楽天ポイント案件

### WIN×Ⅱでの利用シーン

1. **楽天市場商品**
   - 楽天市場の全商品を対象としたアフィリエイト
   - 報酬率: 通常2% - 8%

2. **楽天サービス案件**
   - 楽天カード、楽天証券、楽天モバイルなど
   - 高単価案件（3,000円〜10,000円）

3. **大手企業案件**
   - ユニクロ、無印良品、ビックカメラなど

---

## WIN×ⅡでのLinkShare統合目的

### 主要目標

1. **楽天市場商品の自動トラッキング**
   - 成果レポートAPIによる自動取得
   - 楽天市場全体の購入を対象

2. **メンバー別トラッキング**
   - カスタムパラメータ `u1` の利用
   - クリックログとの照合

3. **楽天エコシステムの活用**
   - 楽天ポイント案件との連携
   - 楽天サービス全体のキャッシュバック提供

### 期待される効果

- **楽天市場の自動化:** 手動運用の廃止
- **報酬率の向上:** 2% - 8%の報酬率
- **楽天ユーザーの囲い込み:** 楽天エコシステムとの連携

---

## 利用可能なAPI機能

### LinkShare API一覧

LinkShareは以下のAPIを提供しています：

| API名 | 機能 | WIN×Ⅱでの利用 | ステータス |
|-------|------|--------------|-----------|
| **トランザクションレポートAPI** | 成果データ取得 | ✅ **メイン利用** | 利用可能 |
| 商品検索API | 楽天市場商品検索 | ⏸️ 今後検討 | 利用可能 |
| リンク生成API | ディープリンク生成 | ⏸️ 今後検討 | 利用可能 |

### トランザクションレポートAPIの主要機能

**エンドポイント:**
```
GET https://reportws.linksynergy.com/downloadreport.php
```

**認証方式:** APIトークン（クエリパラメータ: `token={API_TOKEN}`）

**取得可能なデータ:**
- トランザクションID
- トランザクション日時
- 報酬額
- 承認状況
- カスタムパラメータ `u1`（**メンバーID照合に使用**）
- 広告主情報
- 商品名・商品URL

**APIの特徴:**
- ✅ カスタムパラメータ `u1` 対応
- ✅ CSVフォーマットでのレスポンス
- ⚠️ 日次バッチ処理（リアルタイム取得不可）
- ⚠️ レート制限: 1,000リクエスト/日

**リクエストパラメータ:**
| パラメータ | 必須 | 説明 | 例 |
|-----------|------|------|-----|
| `token` | ✅ | APIトークン | `xxxxx` |
| `bdate` | ✅ | 検索開始日（YYYYMMDD） | `20250101` |
| `edate` | ✅ | 検索終了日（YYYYMMDD） | `20250131` |
| `nid` | ❌ | ネットワークID（楽天: 1） | `1` |

**レスポンス形式:** `text/csv`

```csv
Transaction ID,Transaction Date,Commission,Status,u1,Merchant Name,Product Name
LS-12345678,2025-01-03 14:30:00,300,Approved,member-a1b2c3d4,Rakuten,商品名
```

---

## カスタムトラッキングパラメータ

### `u1` パラメータとは

LinkShareの **u1パラメータ** は、アフィリエイトリンクに付与できるカスタムパラメータです。

#### 基本仕様

| 項目 | 詳細 |
|------|------|
| **パラメータ名** | `u1` |
| **最大文字数** | 100文字 |
| **使用可能文字** | 半角英数字、ハイフン（-）、アンダースコア（_） |
| **設定方法** | アフィリエイトリンクに `&u1={value}` を追加 |
| **取得方法** | トランザクションレポートAPI の `u1` フィールド |

#### WIN×Ⅱでの利用方法

```
# クリック時にメンバーIDをu1に設定
https://click.linksynergy.com/link?id={PubID}&offerid={OfferID}&u1={memberId}

例:
u1=member-a1b2c3d4-e5f6-7890-abcd-ef1234567890
u1=guest:550e8400-e29b-41d4-a716-446655440000
```

---

## 評価スコア詳細

**総合スコア: 20/40点（Phase 4推奨）**

| 評価項目 | 配点 | 獲得点 | 理由 |
|---------|------|--------|------|
| **自動化レベル** | 10点 | 3点 | 日次バッチ処理、リアルタイム性なし |
| **会員別トラッキング精度** | 10点 | 9点 | `u1` パラメータで高精度対応 |
| **実装難易度** | 5点 | 2点 | CSV形式、パース処理が複雑 |
| **ドキュメント品質** | 5点 | 2点 | 英語ドキュメント、日本語サポート少ない |
| **ビジネス価値** | 4点 | 3点 | 楽天市場の報酬率（2%-8%）、案件数多数 |
| **レスポンス速度** | 3点 | 0点 | 日次バッチ（1日1回） |
| **エラーハンドリング** | 3点 | 1点 | CSVパースエラーリスク高い |

### Phase 4推奨の理由

1. **リアルタイム性の欠如** - 日次バッチ処理のため、即座に成果が反映されない
2. **CSV形式の複雑性** - JSONではなくCSV、パース処理が煩雑
3. **ビジネス優先度** - 楽天市場の報酬率が低い（2%-8%）、Phase 1-3の案件より優先度低い

---

## 実装時の注意点

### 1. 日次バッチ処理

**特徴:**
- トランザクションレポートは **1日1回** 更新
- 前日分の成果データを翌日に取得可能
- リアルタイム反映は不可

**対応策:**
- Cron頻度: 1日1回（深夜1時推奨）
- メンバーへの通知: 「成果反映まで最大24時間かかる」旨を明示

### 2. CSV形式のパース

**課題:**
- JSONではなくCSV形式
- 文字エンコーディング問題（UTF-8, Shift_JIS）
- カンマ区切りの商品名でパースエラーの可能性

**対応策:**
```typescript
// lib/linkshare-api.ts
import { parse } from "csv-parse/sync";

export async function parseTransactionCSV(csvString: string): Promise<Transaction[]> {
  const records = parse(csvString, {
    columns: true,           // ヘッダー行を列名として使用
    skip_empty_lines: true,
    trim: true,
    encoding: "utf-8",
  });

  return records.map((record: any) => ({
    transactionId: record["Transaction ID"],
    transactionDate: record["Transaction Date"],
    commission: Number(record["Commission"]) || 0,
    status: record["Status"],
    u1: record["u1"] || "",
    merchantName: record["Merchant Name"],
    productName: record["Product Name"],
  }));
}
```

### 3. 楽天市場の低報酬率

**報酬率:**
- 通常商品: 2% - 4%
- 特定カテゴリ: 最大8%

**対策:**
- 高報酬率カテゴリの案件を優先
- 楽天カード・楽天モバイル等の高単価案件を併用
- メンバーに報酬率を事前に明示

---

## Phase 4実装計画（仮）

### 前提条件

- Phase 1-3の実装・運用が安定していること
- 楽天市場案件のニーズが確認できること

### Step 1: API仕様確認（3-5日）

1. LinkShare公式ドキュメント精査
2. テストアカウントでのCSV取得
3. u1パラメータの動作確認

### Step 2: 実装（7-10日）

1. CSV取得・パース処理実装
2. u1パラメータ照合処理
3. 日次Cronジョブ設定
4. エラーハンドリング（CSVパースエラー対応）

### Step 3: テスト・デプロイ（5-7日）

1. ローカル環境でのテスト
2. 実運用テスト（1週間）
3. 本番デプロイ

---

## 参考リンク

### 公式リンク

- [LinkShare Japan](https://www.linkshare.ne.jp/)
- [LinkShare APIドキュメント](https://rakutenmarketing.com/affiliate/documentation)（英語）

### WIN×Ⅱ関連ドキュメント

- [ASP統合プロジェクト概要](./README.md)
- [ASP比較レポート](./asp-comparison-report.md)

---

## まとめ

### 現在のステータス

⏸️ **Phase 4保留中** - Phase 1-3の実装完了後に検討

### 判断基準

**Phase 4実装を開始する条件:**
- ✅ Phase 1-3の運用が安定
- ✅ 楽天市場案件のニーズが高い
- ✅ リソースに余裕がある

**実装を見送る条件:**
- ❌ リアルタイム性の欠如が致命的
- ❌ 報酬率が低く、ビジネス価値が薄い
- ❌ 他のASPで十分なカバレッジ

---

_Last Updated: 2025-01-04_
_Document Version: 1.0.0_
_Maintained by: WIN×Ⅱ Development Team_
