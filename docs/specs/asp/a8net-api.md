## ⚠️ 重要な制限事項（2025-01-04 確認）

### 現在のWIN×Ⅱ A8.net契約状況

**契約種別:** Media Member（メディア会員）
**利用可能な管理画面:** Media Member Dashboard

### 個別成果トラッキングの可否

❌ **実装不可能** - Media Member契約では以下の情報にアクセスできません：

- 個別の成果データ（order_no, order_click_date を含む詳細情報）
- カスタムトラッキングパラメータ（id1, eventId）の個別マッチング
- A8.net確定API v3（**広告主専用機能**のため利用不可）

✅ **利用可能な機能:**

- 集計レポートのダウンロード（プログラム別総報酬額、クリック数）
- 手動CSVエクスポート（現在の運用方法）
- 月次/日次の売上集計データ

### 代替実装方法

以下のドキュメントに記載されている「API自動取得による個別成果トラッキング」は、**広告主契約が前提**となっており、Media Member契約では実装できません。

**推奨される代替案:**

1. **AFB優先実装（最優先）**
   - AFBのリアルタイムポストバックを使用し、会員別トラッキングを実装
   - A8.netは集計レポートとして使用（会員別キャッシュバックなし）
   - 詳細: `docs/specs/asp/afb-implementation-guide.md`

2. **A8.netサポートへの問い合わせ**
   - Media Member向けの個別成果データ取得方法の確認
   - 期待値: 低（Media Member向けAPIが存在する可能性は低い）

3. **広告主契約への変更検討**
   - ビジネスモデルの変更を伴うため慎重な検討が必要
   - 契約変更後、以下のAPI統合実装が可能になる

**注意:** 以下のセクションは「広告主契約を取得した場合」の参考情報として記載しています。

---

## ① 調査結果：A8 確定API v3の主な仕様（広告主契約前提）

### システム概要・機能一覧

* A8 確定 API v3 では、

  * 未確定売上データの取得（/unsealed） ([document.a8.net][1])
  * 未確定件数取得（プログラム指定／広告主指定） ([document.a8.net][1])
  * 売上データの修正（/modify） ([document.a8.net][1])
  * 売上データの確定（/decide）
  * 売上データのキャンセル（/cancel） ([document.a8.net][1])
  * 当日確定データ取得（/sealed/today）および確定済みデータ取得（/sealed） ([document.a8.net][1])
* レスポンスは JSON 形式。時刻は日本標準時 (UTC+9) にて動作。 ([document.a8.net][1])
* エンドポイント例： `https://ecsales-api.a8.net/v3/ins/{PROGRAM_ID}/…` ([document.a8.net][1])
* 注意事項：同一 API キーから 1分間100回を超えるアクセスがあった場合、A8側から用途確認の可能性あり。 ([document.a8.net][1])
* また、取得可能な確定済みデータは「91日以内」など取得期間に制限あり。 ([document.a8.net][1])

### あなたの運用に関わるポイント

* A8 は「成果通知（ポストバック）」ではなく、**成果データを API で取得／修正／確定管理する “pull 型” 方式**が中核仕様であると言えます。
* クリック→成果の関連付けを自社会員ID＋クリックIDで行う場合、A8のAPI取得データ中に「注文番号 (order_no)」「クリック発生日 (order_click_date)」などのフィールドを活用できます。 ([document.a8.net][1])
* ただし、リアルタイムで “クリックIDが発生してから即成果確定” を通知するポストバック的な仕組みは明記されておらず、**定期的な API 取得・突合処理**が前提になります。
* 複数案件・プログラム運用時、「プログラムID (PROGRAM_ID)」「広告主ID (SP_ID)」という識別子が A8 側から発行されており、自社で紐付け設計が必要です。 ([document.a8.net][1])

---

## ② あなたのブログ運営における実装方法（設計＋手順）

あなたの「会員IDを自社で持ち、クリックログを取得している」構成を踏まえて、A8 を活用するための具体設計・手順を以下に整理します。

### 👉 1) クリックログ収集の設計

* ブログ側で会員ログイン → 会員IDを発行／識別。
* 広告リンククリック時にユニークな `click_id` を生成（例： `userID_20251104_0001` 等）。

  * DBテーブル例： `click_logs(click_id, user_id, program_id, timestamp, link_url)`
* リンク URL に、A8 リンクと自身の `click_id` パラメータを付与。例：

  ```
  https://{your‐tracking‐domain}/redirect?click_id=ABC123&user_id=U789
    → リダイレクト後 A8 のアフィリエイトリンク
  ```
* その際、A8 のリンクに紐づくプログラムIDなどを記録しておく。

### 👉 2) A8成果データ取得設計

* A8 API v3 の “未確定データ取得 (/unsealed)” エンドポイントを定期実行（例：毎日・毎数時間）し、未確定成果データを取得。 ([document.a8.net][1])

  * リクエスト例（bash）:

    ```bash
    PROGRAM_ID="s00008100201001"
    API_KEY="your_api_key"
    DATE="20251103"
    curl "https://ecsales-api.a8.net/v3/ins/${PROGRAM_ID}/unsealed?api_key=${API_KEY}&date=${DATE}&limit=1000"
    ```
  * レスポンスには `order_no`（あなたが発番できれば注力）や `order_click_date`（クリック日時）等が含まれ得る。 ([document.a8.net][1])
* 取得データを自社 DB に格納。例： `results(order_id, order_no, decide_flg, pay_money, sales_ymd, order_click_date, program_id)`

### 👉 3) クリックID と成果データの突合

* 自社 DB 内の `click_logs` と A8 取得データを以下のキーで突合：

  * 自社リンク発行時に設定した `order_no`（もし付与可能なら）
  * または `order_click_date` とクリックログの `timestamp` を近似でマッチング
* 成果の確定（ `decide_flg=1`）が確認できたら、 `click_id → user_id → 成果` の紐付けをDB更新。

  * 例： `conversion_logs(click_id, user_id, order_id, pay_money, status, timestamp)`
* 成果確定時に会員にポイント・報酬反映などを実施。

### 👉 4) 承認・キャンセル・変更対応

* A8 API では「修正 (/modify)」「確定 (/decide)」「キャンセル (/cancel)」といった操作も可能です。 ([document.a8.net][1])
* 運用上、成果発生＝即確定ではなく「一定日数後確定」「承認フローあり」のことが多いため、`decide_flg` の値変化を追える設計をしておく。

  * 例：未確定（0）→確定（1）／キャンセルフラグ `del_flg` 等も含まれます。 ([document.a8.net][1])
* DB内でステータス変更をトラッキングし、キャンセルされた分の報酬取り扱いを明確に。

### 👉 5) 定期取得＆ダッシュボード設計

* API呼び出し頻度は、1分間100回を超えないよう制御する必要あり。 ([document.a8.net][1])
* バッチ処理設計例：

  * 毎時間：未確定データ取得 → 突合処理
  * 毎日0-1時：当日確定データ取得（/sealed/today）など → 更新反映
* 取得・変換したデータを会員別・プログラム別・リンク別で集計・ダッシュボード化（例：PowerBI, Google Data Studio など）
* 運用ルールを定義：成果確定から何日超えたら「確定扱い」「取り消し扱い」など。

---

## ③ あなたのブログ運用に向けた「実装ステップ」

1. A8 側で API 利用申請を行い、 **API キー** を取得。
2. ブログ側で `click_id` 発行・リンク URL に付与する仕組みを実装。
3. 自社 DB に `click_logs` テーブルを設計・構築。
4. バッチスクリプト（例：Python／Node.js）を作成：

   * A8 API に GET リクエスト → 未確定データ取得
   * データを DB に格納／既存クリックログと突合
   * 成果確定 orキャンセルステータスを更新
5. 会員向けレポート・管理画面を構築：どの会員がどのリンクで成果？どのプログラム？
6. 定期運用開始：バッチ実行／データモニタリング／異常検知（取得件数の急変など）
7. 将来的に複数ASP（例えば afb）を統合するなら、A8 の取得データも他ASPと同一データ形式に統一する設計を。

---

## ④ 注意・補足事項

* A8 API は **click → 遷移 →成果発生** の “クリックID付与から成果通知” を **完全リアルタイムポストバック形式**で設計されているわけではないため、あなたが「会員ID＋クリックID」を完全に紐付けたい場合、 **クリックURLに自社識別子を付与しておくこと**が重要。
* クリックから成果までの遷移（デバイス変更・Cookie削除・リンクリダイレクト回数など）を考慮し、可能であれば補助的に自社トラッキング（例：パラメータ or サーバー側リファラ）も備えておく。
* データ取得件数の上限（1回あたり10,000件）があり、取得開始位置（offset）やlimit設定をバッチ設計時に考慮する必要あり。 ([document.a8.net][1])
* API呼び出し頻度制限を超えると問い合わせ対象となるリスクあり。フェアユースで設計を。
* 成果確定までのタイムラグ・広告主キャンセルの可能性・返品リスクなど運用リスクも設計に組み込むこと。
* 自社 DB／会員サービス設計時に、個人情報保護・ログ保存期間・外部連携のセキュリティ（APIキー保護、アクセス制限）も確保してください。

[1]: https://document.a8.net/a8docs/ecsales-api/v3/ecsales-api-v3.html "導入仕様書 - A8.net Documents"
