# 🧩 概要：AFBリアルタイムポストバックの目的

**「afb リアルタイムポイントバックシステム」** は、
アフィリエイト成果を **リアルタイムで自動通知（ポストバック）** する仕組みです。

* 複数ASPを利用しているサイトでも、afbからの成果データを外部サーバーに即時連携可能。
* 一元管理サービス（Squad beyond／アフィリコードプラス／AFAD／アドタスカル等）とも連携可。
* GETメソッドによるS2S通信で成果通知を受け取る仕組み。

🥇 第1段階：afb（アフィb） —「最もスムーズに成果ポストバックを導入できる」
✅ 理由

公開で 「リアルタイムポストバック」対応 を明言している国内唯一クラスのASP。

click_id をURLパラメータに持たせ、そのままS2S（Server-to-Server）で通知を受け取れる。

開発者向けドキュメントが充実しており、PHP・Node.js・Python いずれでも容易に受信処理を実装可能。

API連携（成果一覧の取得）もあるため、ポストバックと定期同期の二重管理ができる。

案件単価も比較的高く、まず1社導入してROIを見やすい。

💡 実装ステップ

afb管理画面で ポストバックURLを登録。

自サイト側のクリックリンクに click_id を追加（例：...?click_id=abc123&uid=999）。

afbが成果発生時に https://yourdomain.com/postback?click_id=abc123&price=3000 を叩く。

自社DBで click_id に一致するクリックレコードを更新して成果確定。

---

# 🧱 ステップ別 拡張導入フロー

## 🥇 ① 初期登録（AFBへの申請）

**AFB側にポストバック設定申請を行う必要があります。**
以下の情報を [申請フォーム](https://docs.google.com/forms/d/e/1FAIpQLSfdulbxglFBUnSsIIIqJjw_jimnTDlgGB1gFmJW0985_800YQ/viewform?usp=sf_link) から送信します。

| 入力項目      | 内容                                                                                                     |
| --------- | ------------------------------------------------------------------------------------------------------ |
| afbサイトID  | 成果通知を受けたいサイトすべてのID                                                                                     |
| ポストバックURL | あなたのサーバーで受け取るエンドポイントURL（例：[https://yourdomain.com/afb/postback）](https://yourdomain.com/afb/postback）) |
| 通知タイプ     | 「成果承認時」または「ステータス変更時（発生・承認・却下）」を選択                                                                      |
| 再送設定      | 通知失敗時の再送をONに（推奨）<br>※再送タイミング：毎日午前2時／最大3回／送信元IP：180.211.73.218,112.137.189.110                          |

---

## 🧪 ② 疎通テスト（E2E確認）

AFBが提供するテスト案件を使って、通信の正しさを確認します。

| テスト案件         | PID   | 内容      |
| ------------- | ----- | ------- |
| E2Eテスト（タグ・定額） | 11928 | 固定報酬テスト |
| E2Eテスト（タグ・定率） | 11959 | 変動報酬テスト |

**手順：**

1. テストコードがafbから送られる。
2. リンクをクリックし、LP → 成果ページへ遷移。
3. 成果が発生し、自サイトまたは一元管理サービスで通知を受信できるか確認。
4. 確認後、afbに「テスト完了」を報告（報酬対象外）。

⚠️ 注意：疎通テストをスキップすると設定ミスに気づけず、通知漏れのリスクあり。

---

## 🔗 ③ クリックURLへのパラメータ付与

広告リンクにあなたの**会員ID（またはセッションID）を動的付与**する必要があります。

**例：**

```html
<!-- 通常のafbリンク -->
<a href="http://track.affiliate-b.com/visit.php?a=00&p=00">〜〜〜</a>

<!-- 拡張後（paidパラメータ付与） -->
<a href="http://track.affiliate-b.com/visit.php?a=00&p=00&paid={USER_ID}">〜〜〜</a>
```

* `paid` はデフォルトのパラメータ名。変更も可能（申請フォームで指定）。
* `USER_ID` には、あなたのシステム内で発行しているユーザー識別子を埋め込む。
* afb側で `paid` 値を記録し、成果CSVの「L列」にポイントバックIDとして反映されます。

---

## ⚙️ ④ 成果通知（ポストバック）受信設計

afbが成果を確定または更新するたびに、指定したURLへGETメソッドで通知します。

**通知されるパラメータ（デフォルト仕様）**

| パラメータ       | 内容                          | 例                     |
| ----------- | --------------------------- | --------------------- |
| `paid`      | あなた側で設定した会員ID（クリック時に付与された値） | `12345`               |
| `adid`      | 広告ID（afb内部の広告主管理番号）         | `789`                 |
| `time`      | 成果発生日／変更日時                  | `2025-11-03 21:00:00` |
| `judgetime` | 成果確定日（任意）                   | `2025-11-05 09:00:00` |
| `price`     | 成果報酬金額                      | `4500`                |
| `judge`     | ステータス（0:未承認／1:承認／9:非承認）     | `1`                   |
| `u`         | 成果個別ID（ユニークキー）              | `abc123xyz`           |
| `amount`    | 売上金額（EC案件のみ）                | `12000`               |

**送信仕様**

* メソッド：`GET`
* 送信元IP：`13.114.169.190`（本番環境）
* 受信時にはこのIPをホワイトリスト登録推奨。

---

## 🧩 ⑤ 自社DB連携の実装例

### Python（Flask）受信例

```python
from flask import Flask, request
import sqlite3
app = Flask(__name__)

@app.route("/afb/postback", methods=["GET"])
def receive_afb_postback():
    data = request.args.to_dict()
    paid = data.get("paid")
    click_id = data.get("u")
    reward = float(data.get("price", 0))
    status = data.get("judge")
    adid = data.get("adid")

    # データベースに保存・更新
    conn = sqlite3.connect("affiliate.db")
    c = conn.cursor()
    c.execute("""
        INSERT OR REPLACE INTO afb_results
        (click_id, paid, adid, reward, status)
        VALUES (?, ?, ?, ?, ?)
    """, (click_id, paid, adid, reward, status))
    conn.commit()
    conn.close()

    return "OK", 200
```

このようにすれば、自社側で「会員ID（paid）→報酬金額・ステータス」の紐付けが即時反映されます。

---

# 🔍 発展：一元管理との統合

afbのリアルタイムポストバックは、**複数ASP統合管理サービス**とも連携可能です。

| 対応サービス           | 特徴                        |
| ---------------- | ------------------------- |
| **Squad Beyond** | 高精度分析と自動レポート機能。複数ASP統合型。  |
| **アフィリコードプラス**   | 自社運営メディア用の中核トラッカーとして拡張可能。 |
| **AFAD／アドマージ**   | 成果データを日次集約・可視化。           |

→ あなたのブログが将来的に複数ASPを導入する際、このポストバックを「統合API」へ中継すれば、**全ASP成果を一括DB化**できます。

---

# 🧠 導入後の運用ポイント

| 項目          | 内容                                                                  |
| ----------- | ------------------------------------------------------------------- |
| **再送確認**    | 成果未受信時、afbが最大3回再送（午前2時）してくれるため、重複登録を避けるために`click_id`または`u`をユニーク制約に。 |
| **テスト環境整備** | 疎通テスト（E2E案件）を必ず実施。成果が反映されているか確認。                                    |
| **承認後更新**   | 成果ステータスが「承認」になった時のみ会員報酬反映。                                          |
| **IP制限**    | 通知元IP（13.114.169.190）を固定し、不正アクセスを防止。                                |

---

# 🏁 まとめ：AFB拡張の最適ステップ

| フェーズ      | 実施内容                  | 成果           |
| :-------- | :-------------------- | :----------- |
| ① 申請      | ポストバックURL・サイトID登録     | afb通知有効化     |
| ② 疎通テスト   | テスト案件で確認              | 通信正常確認       |
| ③ リンク改修   | `&paid={user_id}` を追加 | 会員ID追跡可能化    |
| ④ 受信API構築 | GET受信エンドポイント実装        | 自社DB更新       |
| ⑤ 運用・分析   | 成果データを自動集約・可視化        | 一元管理・ROI分析可能 |
