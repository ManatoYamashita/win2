# もしもアフィリエイト API - 概要

**最終更新日:** 2025-01-04
**実装優先度:** 🥉 Phase 3（24点/40点）
**実装ステータス:** 🔍 調査中

---

## 目次

1. [もしもアフィリエイトとは](#もしもアフィリエイトとは)
2. [WIN×ⅡでのもしもAFB統合目的](#winⅱでのもしもafb統合目的)
3. [利用可能なAPI機能](#利用可能なapi機能)
4. [カスタムトラッキングパラメータ](#カスタムトラッキングパラメータ)
5. [実装アーキテクチャ](#実装アーキテクチャ)
6. [評価スコア詳細](#評価スコア詳細)
7. [実装時の注意点](#実装時の注意点)
8. [参考リンク](#参考リンク)

---

## もしもアフィリエイトとは

### サービス概要

**もしもアフィリエイト** は、個人ブロガーに特化したアフィリエイトサービスで、以下の特徴があります：

- **設立:** 2004年
- **運営会社:** 株式会社もしも
- **特徴:** W報酬制度（通常報酬 + 12%のボーナス報酬）
- **強み:** Amazon・楽天の簡単リンク機能、初心者向けサポート充実

### WIN×Ⅱでの利用シーン

1. **Amazon・楽天案件**
   - Amazonアソシエイト、楽天アフィリエイトの一元管理
   - 「かんたんリンク」機能による商品リンク生成

2. **プログラミング・IT系案件**
   - レンタルサーバー（ConoHa、エックスサーバーなど）
   - ドメイン取得サービス
   - プログラミングスクール

3. **W報酬によるキャッシュバック増額**
   - 通常報酬の112%を獲得
   - WIN×Ⅱメンバーには20%キャッシュバック（ボーナス報酬込み）

---

## WIN×ⅡでのもしもAFB統合目的

### 主要目標

1. **個別成果の自動取得**
   - レポートAPIによる定期的な成果データ取得
   - 手動CSV貼り付け作業の自動化

2. **メンバー別トラッキング（要確認）**
   - カスタムパラメータの利用可否を確認中
   - 公式ドキュメントでの記載が不明確

3. **W報酬を含むキャッシュバック計算**
   - 通常報酬 × 1.12 × 0.2 = キャッシュバック額
   - ボーナス報酬も含めた正確な計算

### 期待される効果

- **運用工数削減:** 手動CSV操作の廃止（月間1-2時間削減）
- **W報酬の活用:** ボーナス報酬12%を反映したキャッシュバック計算
- **Amazon・楽天統合:** 複数ASPを一元管理

---

## 利用可能なAPI機能

### もしもアフィリエイト API一覧

もしもアフィリエイトは以下のAPIを提供しています：

| API名 | 機能 | WIN×Ⅱでの利用 | ステータス |
|-------|------|--------------|-----------|
| **レポートAPI** | 成果データ取得 | ✅ **メイン利用** | 調査中 |
| プロモーション検索API | 案件情報検索 | ⏸️ 今後検討 | 利用可能 |
| かんたんリンクAPI | 商品リンク生成 | ⏸️ 今後検討 | 利用可能 |

### レポートAPIの主要機能（推定）

**公式ドキュメント確認が必要です。**

**取得可能なデータ（推定）:**
- 成果ID（Order ID）
- 成果発生日時
- 報酬額（W報酬含む）
- 承認状況（承認/非承認/保留）
- カスタムパラメータ（**要確認**）
- プロモーション情報

**APIの特徴（推定）:**
- ✅ 日別・月別の集計レポート
- ⚠️ カスタムトラッキングパラメータの利用可否が不明
- ⚠️ API認証方式が不明（APIキー、OAuth等）
- ⚠️ レート制限が不明

---

## カスタムトラッキングパラメータ

### 現在のステータス: **要確認**

もしもアフィリエイトの公式ドキュメントでは、カスタムトラッキングパラメータに関する情報が明確に記載されていません。

### 調査が必要な項目

1. **カスタムパラメータの利用可否**
   - アフィリエイトリンクにメンバーIDを付与できるか
   - パラメータ名（例: `a_id`, `ref`, `sid` など）
   - 最大文字数、使用可能文字

2. **成果レポートでの取得可否**
   - レポートAPIでカスタムパラメータの値が取得できるか
   - フィールド名の確認

3. **公式サポートへの問い合わせ**
   - カスタムトラッキングの実装方法
   - レポートAPIの詳細仕様

### 代替案（カスタムパラメータが利用不可の場合）

**案1: 時間範囲＋案件名マッチング**
- クリックログの時間範囲（±24時間）で候補を絞る
- 案件名の完全一致・部分一致でスコアリング
- 精度: 70-80%（複数候補がある場合は手動確認）

**案2: もしもアフィリエイト専用の短縮URL**
- bit.ly等の短縮URLサービスを利用
- 短縮URL作成時にメンバーIDを記録
- クリック解析でメンバー識別
- 実装複雑度: 高

---

## 実装アーキテクチャ

### データフロー（推定）

```
[1. ユーザークリック]
    ↓
[2. /api/track-click]
    - カスタムパラメータ付きリンク生成（要確認）
    - Google Sheets「クリックログ」に記録
    ↓
[3. もしもアフィリエイト管理画面]
    - 成果発生・承認処理
    - W報酬（+12%）自動計算
    ↓
[4. 定期ポーリング（1時間間隔推奨）]
    - Vercel Cron Job: /api/cron/moshimo-sync
    - レポートAPI呼び出し
    ↓
[5. 成果データ処理]
    - JSONパース
    - カスタムパラメータとクリックログ照合（利用可能な場合）
    - メンバーID識別
    ↓
[6. Google Sheets書き込み]
    - 「成果CSV_RAW」に追記
    - W報酬込みの報酬額を記録
    ↓
[7. GAS自動処理（毎日3:10）]
    - キャッシュバック計算（報酬 × 20%）
    - 「成果データ」シート出力
    ↓
[8. メンバーダッシュボード]
    - /mypage/history でキャッシュバック履歴表示
```

### 実装ファイル構成（予定）

```
lib/
├── moshimo-api.ts                # API統合ロジック
│   ├── fetchReport()             # レポート取得
│   └── parseReportJSON()         # JSON → 型変換

app/api/cron/moshimo-sync/
└── route.ts                      # 定期同期Cronジョブ

types/
└── moshimo.ts                    # 型定義
    ├── ReportRequest
    ├── ReportResponse
    └── Order
```

---

## 評価スコア詳細

**総合スコア: 24/40点（Phase 3推奨）**

| 評価項目 | 配点 | 獲得点 | 理由 |
|---------|------|--------|------|
| **自動化レベル** | 10点 | 5点 | レポートAPI利用、ポーリング必須（1時間間隔推奨） |
| **会員別トラッキング精度** | 10点 | **4点** | **カスタムパラメータ利用可否が不明**（要確認） |
| **実装難易度** | 5点 | 3点 | API認証方式が不明、ドキュメント不足 |
| **ドキュメント品質** | 5点 | 2点 | 公式ドキュメントが不十分、サンプルコード少ない |
| **ビジネス価値** | 4点 | 4点 | Amazon・楽天統合、W報酬制度、初心者向け案件多数 |
| **レスポンス速度** | 3点 | 2点 | ポーリング必須（1時間間隔推奨） |
| **エラーハンドリング** | 3点 | 2点 | レート制限・エラーコードが不明 |
| **その他** | - | +2点 | W報酬（+12%）による高報酬 |

### 実装優先度の判断

**Phase 3推奨の理由:**
1. **カスタムトラッキングが不明確** - メンバー別トラッキングの実現可否が確定していない
2. **ドキュメント不足** - API仕様の詳細確認が必要
3. **Phase 1-2の実績評価後** - AFB・ValueCommerceの運用実績を見てから実装判断

**Phase 3での作業内容:**
1. もしもアフィリエイト公式サポートへの問い合わせ
2. カスタムトラッキングパラメータの仕様確認
3. レポートAPIの詳細ドキュメント取得
4. テスト実装とフィージビリティ検証

---

## 実装時の注意点

### 1. 公式ドキュメントの確認必須

**現在の状況:**
- ⚠️ カスタムトラッキングパラメータの記載なし
- ⚠️ レポートAPIの詳細仕様が不明
- ⚠️ API認証方式が不明

**Phase 3開始前に確認すべき項目:**
- [ ] レポートAPIのエンドポイントURL
- [ ] 認証方式（APIキー、OAuth、Basic認証など）
- [ ] カスタムトラッキングパラメータの利用可否
- [ ] レート制限
- [ ] エラーコード一覧

### 2. W報酬の計算

**通常報酬 + ボーナス報酬（12%）の合計を記録**

```typescript
// 例: 通常報酬 10,000円の場合
const normalReward = 10000;
const wRewardBonus = normalReward * 0.12; // 1,200円
const totalReward = normalReward + wRewardBonus; // 11,200円

// Google Sheetsに記録する報酬額
const rewardAmount = totalReward; // 11,200円

// キャッシュバック計算（GAS側）
const cashback = totalReward * 0.2; // 2,240円
```

### 3. Amazon・楽天案件の特殊処理

**もしもアフィリエイト経由のAmazon・楽天は報酬計算が異なる場合がある:**
- Amazon: 商品カテゴリによって報酬率が変動（0.5% - 10%）
- 楽天: 購入金額の一定率（通常1% - 10%）

**対応策:**
- 案件名に「Amazon」「楽天」が含まれる場合は特別処理
- 報酬額が変動する旨をメンバーに通知

### 4. カスタムトラッキングが利用不可の場合

**代替実装（時間範囲マッチング）:**
1. 成果発生日時の ±24時間 内のクリックログを抽出
2. 案件名の一致度でスコアリング
3. スコア上位候補をメンバーダッシュボードで表示
4. 手動確認・承認機能の実装

---

## Phase 3実装計画（仮）

### Step 1: 情報収集（3-5日）

1. もしもアフィリエイト公式サポートへの問い合わせ
   - カスタムトラッキングパラメータの利用可否
   - レポートAPIの詳細仕様
   - サンプルレスポンス取得

2. テストアカウントでの動作確認
   - 手動でカスタムパラメータ付きリンクをテスト
   - 成果発生後、レポートで取得できるか確認

### Step 2: 実装（5-7日）

**カスタムトラッキングが利用可能な場合:**
1. レポートAPI統合ロジック実装
2. カスタムパラメータ照合処理
3. Cronジョブ設定

**カスタムトラッキングが利用不可の場合:**
1. 時間範囲マッチングロジック実装
2. 手動確認UI実装（/admin/moshimo-matching）
3. スコアリングアルゴリズム実装

### Step 3: テスト・デプロイ（3-5日）

1. ローカル環境でのテスト
2. テストアカウントでの実運用テスト
3. 本番デプロイ
4. 1週間の動作監視

---

## 参考リンク

### 公式リンク

- [もしもアフィリエイト公式サイト](https://af.moshimo.com/)
- [もしもアフィリエイト API仕様](https://af.moshimo.com/developer/)（要ログイン）
- [もしもアフィリエイト サポート](https://support.moshimo.com/)

### WIN×Ⅱ関連ドキュメント

- [ASP統合プロジェクト概要](./README.md)
- [ASP比較レポート](./asp-comparison-report.md)
- [AFB実装ガイド](./afb-implementation-guide.md)（参考実装）
- [ValueCommerce実装ガイド](./valuecommerce/order-api-guide.md)（参考実装）

---

## まとめ

### 現在のステータス

🔍 **調査中** - カスタムトラッキングパラメータの利用可否が不明

### 次のアクション

1. **Phase 2完了後** - AFB・ValueCommerceの運用実績評価
2. **公式サポート問い合わせ** - カスタムトラッキングの詳細確認
3. **Phase 3開始** - 情報収集完了後、実装開始判断

### 判断基準

**Phase 3実装を開始する条件:**
- ✅ カスタムトラッキングパラメータが利用可能
- ✅ レポートAPIの詳細仕様が確認できた
- ✅ Phase 2の運用が安定している

**実装を見送る条件:**
- ❌ カスタムトラッキングが利用不可で、代替案の精度が低い
- ❌ API制限が厳しく、実用性が低い
- ❌ ビジネス価値が想定より低い

---

_Last Updated: 2025-01-04_
_Document Version: 1.0.0_
_Maintained by: WIN×Ⅱ Development Team_
