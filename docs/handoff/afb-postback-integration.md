# AFBポストバック統合実装 - 完了報告

**作成日:** 2025-11-03
**実装完了日:** 2025-11-03
**ステータス:** ⚠️ 実装完了、AFB申請失敗のため一旦中断

---

## ⚠️ 中断について（2025-11-04）

**中断理由:**
- AFBのアカウント登録申請が失敗したため、ポストバック統合は一旦中断いたします。

**実装状態:**
- ✅ コア実装完了（型定義、Webhookエンドポイント、クリックトラッキング修正）
- ✅ ローカルテスト成功
- ⚠️ 本番運用は保留中（AFB申請が必要）

**再開時の手順:**
1. AFBアカウント登録を再申請
2. AFB管理画面でサイトIDを確認
3. AFBポストバック申請フォームを送信（下記「AFB申請フォーム入力内容」参照）
4. 承認後、疎通テストを実施（下記「次のステップ」参照）
5. 本番運用開始

**実装ファイル:**
- すべて保持されており、いつでも再開可能です。
- 実装コードは削除せず、ドキュメントのみ「中断」状態として記録しております。

---

## 📋 実装サマリー

AFBリアルタイムポストバックシステムの統合実装が完了しました。

**重要な発見:**
- AFBは**明確にリアルタイムポストバックをサポート**しており、`paid`パラメータで会員IDを直接取得可能
- 前回実装したAPIポーリング方式は、情報不足による誤判断でした
- ポストバック方式なら、推測マッチングアルゴリズムは**不要**

**実装結果:**
- ✅ 完全自動マッチング実現（`paid`パラメータで会員ID直接取得）
- ✅ リアルタイム通知（成果発生時に即時通知）
- ✅ 手動確認フロー不要
- ✅ 重複成果のスキップ（再送対応）

---

## 📂 実装ファイル一覧

### 新規作成ファイル

1. **`types/afb-postback.ts`** - AFBポストバック型定義
   - AfbPostbackParams（GETパラメータ）
   - ParsedAfbPostbackData（内部処理用）
   - convertAfbPostbackStatus（ステータス変換）
   - parseAfbPostbackParams（パース処理）

2. **`app/api/webhooks/afb-postback/route.ts`** - Webhook受信エンドポイント
   - GETメソッドハンドラー
   - 送信元IP検証（13.114.169.190, 180.211.73.218, 112.137.189.110）
   - パラメータバリデーション
   - 重複チェック（`u`パラメータ）
   - Google Sheets記録
   - エラーハンドリング

3. **`docs/handoff/afb-postback-integration.md`** - 本ドキュメント

### 修正ファイル

1. **`app/api/track-click/route.ts`** - クリックトラッキング修正
   - AFBの案件の場合のみ`&paid={memberId}`パラメータを追加
   - 117-120行目に追加

---

## 🧪 テスト結果

### テスト1: ポストバック受信成功

**リクエスト:**
```bash
curl "http://localhost:3001/api/webhooks/afb-postback?paid=test-member-123&adid=789&time=2025-11-03%2022:00:00&price=4500&judge=1&u=test-unique-id-001"
```

**レスポンス:**
```json
{
  "success": true,
  "message": "Postback received and recorded successfully",
  "data": {
    "memberId": "test-member-123",
    "uniqueId": "test-unique-id-001",
    "rewardAmount": 4500,
    "status": "approved"
  }
}
```

**Google Sheets記録:**
- ✅ B列（追跡ID）: `test-member-123`（会員ID直接記録！）
- ✅ D列（案件名）: `AFB広告ID:789`
- ✅ F列（報酬額）: `4500`
- ✅ G列（承認状況）: `approved`
- ✅ H列（注文ID）: `test-unique-id-001`

### テスト2: 重複成果のスキップ

**リクエスト:**
```bash
# 同じ u パラメータで再送信
curl "http://localhost:3001/api/webhooks/afb-postback?paid=test-member-123&adid=789&time=2025-11-03%2022:00:00&price=4500&judge=1&u=test-unique-id-001"
```

**レスポンス:**
```json
{
  "success": true,
  "message": "Duplicate conversion skipped",
  "uniqueId": "test-unique-id-001"
}
```

**結果:** ✅ 重複成果が正しくスキップされました。AFBの再送処理（最大3回）に対応可能。

---

## 📝 AFB申請フォーム入力内容

AFBポストバックを有効化するため、以下の情報で申請フォームを送信してください。

**申請フォームURL:**
https://docs.google.com/forms/d/e/1FAIpQLSfdulbxglFBUnSsIIIqJjw_jimnTDlgGB1gFmJW0985_800YQ/viewform

| 項目 | 入力内容 |
|---|---|
| **パートナーID** | `961182` |
| **お名前** | `（AFBアカウントに登録されている名前）` |
| **ご連絡先メールアドレス** | `manapuraza@gmail.com` |
| **サイトID** | `（要確認）` ← **AFB管理画面で確認してください** |
| **ポストバックURL** | `https://www.win-otoku.com/api/webhooks/afb-postback` |
| **ポストバック通知タイプ** | ✅ **「ステータス（発生、承認、却下）変更時」** |
| **データの再送について** | ✅ **「再送信する」** |
| **備考** | 「Next.jsでの実装です。疎通テスト希望。」（任意） |

### ❓ サイトIDの確認方法

1. AFB管理画面（https://www.afi-b.com/）にログイン
   - ID: `ohshiro-group`
   - PW: `kanri1993`
2. 「サイト管理」または「サイト一覧」メニューを開く
3. 登録済みサイト（www.win-otoku.com）のID（数字）を確認
4. 複数ある場合は「、」区切りで全て記載（例：`12345、67890`）

---

## 🔜 次のステップ

### 1. AFB申請（所要時間：5分）

- [ ] AFB管理画面でサイトIDを確認
- [ ] 上記の申請フォームを送信
- [ ] 承認待ち（1-2営業日）

### 2. 疎通テスト（承認後、所要時間：30分）

AFBから承認通知が来たら：

- [ ] AFBテスト案件（PID: 11928 または 11959）でテスト
- [ ] テストリンクをクリック → LP → 成果ページへ遷移
- [ ] Google Sheets「成果CSV_RAW」にデータが記録されるか確認
- [ ] B列（追跡ID）に会員IDが正しく記録されているか確認
- [ ] AFBに「テスト完了」を報告

### 3. 本番運用開始

- [ ] 既存のAFB案件リンクが正常動作するか確認
- [ ] 成果データが自動的にGoogle Sheetsに記録されることを確認

---

## 💡 重要な技術的決定事項

### 1. ポストバック方式 vs APIポーリング方式

| 項目 | ポストバック方式（今回実装） | APIポーリング方式（前回実装） |
|---|---|---|
| **会員ID取得** | `paid`パラメータで直接取得 ✅ | 取得不可 ❌（推測マッチング） |
| **リアルタイム性** | 即時通知 ✅ | 1時間遅延 ❌ |
| **自動マッチング** | 完全自動 ✅ | 手動確認必須 ❌ |
| **実装複雑度** | シンプル | 複雑（マッチングアルゴリズム） |

**結論:** ポストバック方式が圧倒的に優れており、APIポーリング方式はバックアップ用として保持。

### 2. ハイブリッド構成の採用

**メイン:** ポストバック方式（リアルタイム、完全自動）
**サブ:** APIポーリング方式（日次バッチ、差分同期）

**メリット:**
- ポストバック失敗時も成果データを回収可能
- 二重管理による信頼性向上

**既存実装を削除しない理由:**
- バックアップ同期用として有用
- ポストバック通知漏れのフォールバック
- 過去データの定期同期

### 3. セキュリティ対策

**送信元IP検証:**
- 本番: `13.114.169.190`
- 再送: `180.211.73.218`, `112.137.189.110`
- 開発環境ではIP検証をスキップ（`process.env.NODE_ENV === "development"`）

**重複チェック:**
- `u`パラメータ（成果個別ID）で重複判定
- AFBの再送処理（最大3回）に対応

---

## 🛠️ トラブルシューティング

### ポストバックが受信されない場合

**確認事項:**
1. AFB申請が承認されているか
2. ポストバックURL設定が正しいか
   - 正: `https://www.win-otoku.com/api/webhooks/afb-postback`
   - 誤: `http://localhost:3000/...`（開発環境URL）
3. Vercelデプロイが最新状態か
4. 本番環境の環境変数が設定されているか

**ログ確認:**
- Vercel Dashboard → Logs → Filter: `/api/webhooks/afb-postback`

### 会員IDが記録されない場合

**確認事項:**
1. クリックリンクに`&paid={memberId}`が付与されているか
   - 確認: `/api/track-click`のレスポンスURLをチェック
2. AFBの案件マスタで`aspName`が`"afb"`になっているか
3. Google Sheets「成果CSV_RAW」のB列を確認

### 重複成果が記録される場合

**原因:**
- `u`パラメータが変更されている
- Google Sheets読み込みエラー

**対処法:**
- エンドポイントログで`existingUniqueIds`の内容を確認
- Google Sheets APIクォータを確認

---

## 📊 実装完了チェックリスト

### コア実装

- [x] AFBポストバック型定義作成
- [x] Webhook受信エンドポイント実装
- [x] クリックトラッキング修正（`paid`パラメータ追加）
- [x] Google Sheets書き込み確認
- [x] ローカルテスト実施（成功・重複スキップ確認）

### ドキュメント

- [x] 完了報告ドキュメント作成
- [ ] `docs/asp-api-integration.md` 更新（ポストバック方式への移行）
- [ ] `docs/handoff/asp-integration-session-handoff.md` 更新

### デプロイ・申請

- [ ] Vercel本番環境デプロイ
- [ ] AFB申請フォーム送信
- [ ] 承認待ち（1-2営業日）
- [ ] 疎通テスト実施

### 本番運用

- [ ] 成果データ自動記録確認
- [ ] GAS処理動作確認

---

## 🎯 まとめ

AFBポストバック統合実装により、以下を実現いたしました：

1. ✅ **完全自動マッチング**（`paid`パラメータで会員ID直接取得）
2. ✅ **リアルタイム通知**（成果発生時に即時反映）
3. ✅ **手動確認フロー不要**（推測マッチングアルゴリズム不要）
4. ✅ **重複成果の自動スキップ**（AFB再送対応）
5. ✅ **ハイブリッド構成**（ポストバック + APIポーリング）

**次のアクション（再開時）:**
1. AFBアカウント登録を再申請
2. AFB管理画面でサイトIDを確認
3. AFBポストバック申請フォームを送信
4. 承認後、疎通テストを実施

---

**Last Updated:** 2025-11-04
**Status:** ⚠️ 中断（AFB申請失敗）
**Next Action (再開時):** AFBアカウント登録再申請 → サイトID確認 → ポストバック申請 → 疎通テスト