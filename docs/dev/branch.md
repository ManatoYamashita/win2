# ブランチ戦略ドキュメント

## 概要

win2 アフィリアエイトブログシステムプロジェクトでは、シンプルで効率的なブランチ管理戦略を採用しています。featureブランチから直接mainブランチにマージするフローにより、安全で迅速なデプロイメントを実現します。

## ブランチ体系

### メインブランチ

| ブランチ名 | 役割 | デプロイ先 | 直接Push |
|-----------|------|-----------|----------|
| `main` | 本番用メインブランチ | 本番環境（未デプロイ - Vercelの予定） | 🚫 禁止 |

**重要**: `main`ブランチはfeatureブランチからのプルリクエスト経由でのみ更新されます。

### 開発ブランチ命名規則

```
PREFIX/作業名
```

#### 使用可能なプレフィックス
- `feature/` - 新機能開発
- `fix/` - バグ修正
- `update/` - 既存機能の改善・更新
- `refactor/` - リファクタリング
- `doc/` - ドキュメント更新
- `test/` - テスト追加・修正

#### 例
- `feature/user-dashboard` - ユーザーダッシュボード機能開発
- `fix/responsive-layout` - レスポンシブレイアウト修正
- `update/seo-optimization` - SEO最適化改善
- `refactor/component-architecture` - コンポーネント設計リファクタリング

## ブランチフロー

### 1. 新機能開発の開始

```bash
# 開発作業の開始（mainブランチから分岐）
git checkout main
git pull origin main
git checkout -b feature/新機能名

# または他のプレフィックスでの作業
git checkout -b fix/バグ修正名
git checkout -b update/改善機能名
```

### 2. 開発作業

```bash
# 通常の開発フロー
git add .
git commit -m "PREFIX: コミットメッセージ"
git push origin feature/新機能名
```

### 3. プルリクエスト作成

#### プルリクエストタイトル（必須形式）
```
PREFIX: 機能概要
```

**例**
- `FEATURE: ユーザー登録機能追加`
- `FIX: ログインエラー修正`
- `STYLE: ホームページデザイン改善`
- `DOC: READMEにapiリポジトリの内容追加`

#### プルリクエスト説明（詳細記述必須）
```markdown
## 概要
変更の概要を簡潔に説明

## 変更内容
- 具体的な変更点1
- 具体的な変更点2
- 具体的な変更点3

## 影響範囲
- 影響を受ける機能やページ
- 注意が必要な箇所

## その他
- レビュー時の注意点
- 追加で確認してほしい点
```

#### ターゲットブランチ
- **基本**: `main` (本番環境)
- **緊急修正**: `main` (本番環境直接修正) ※例外的なケースのみ

### 4. レビュー・マージ・リリース

#### 通常フロー（推奨）
1. **コードレビュー実施**
   - 最低1名以上のレビューア承認が必要
   - すべてのコメントが解決済みであること
2. **CI/CDパイプライン通過確認**（将来実装予定）
   - ビルド成功
   - テスト通過
   - Lint/型チェック通過
3. **`main`ブランチにマージ**
   - **🚫 直接pushは禁止**: プルリクエスト経由でのみマージ可能
   - マージ後、本番環境に自動デプロイ（Vercel予定）

#### 緊急修正フロー（例外）
1. **`main`ブランチから直接hotfixブランチ作成**
2. **最小限の修正実装**
3. **`main`への緊急マージ**

## ブランチ保護ルール

### 適用される制限
- **`main`ブランチ**: 
  - 直接push禁止
  - featureブランチからのプルリクエストのみ許可
  - 必須レビュー: 1名以上

## コミットメッセージ規約

### プレフィックス一覧

| プレフィックス | 説明 | 例 |
|---------------|------|-----|
| `FEATURE` | 新機能追加 | `FEATURE: ユーザー登録機能を追加` |
| `UPDATE` | 既存機能の改善・更新 | `UPDATE: ホームページのデザインを改善` |
| `FIX` | バグ修正 | `FIX: ログイン時のエラーを修正` |
| `REFACTORING` | リファクタリング | `REFACTOR: コンポーネント構造を整理` |
| `STYLE` | スタイル・フォーマット変更 | `STYLE: ESLintエラーを修正` |
| `DOC` | ドキュメント更新 | `DOC: READMEにセットアップ手順を追加` |
| `CHORE` | その他 | `CHORE: 本番環境のテストのため` |

### コミットメッセージ形式（必須）

**基本形式**
```
PREFIX: 簡潔な変更内容（50文字以内）

詳細な説明（必要に応じて）
- 変更理由
- 影響範囲
- 注意事項
```

**重要なルール**
- すべてのコミットメッセージは「PREFIX: 内容」形式で開始すること
- プレフィックスは上記の表に従って選択
- コロンの後にスペースを1つ入れること
- 1行目は50文字以内で簡潔に記述
- 詳細説明が必要な場合は2行目を空行にして3行目以降に記述

## ブランチ保護ルール

### 保護されたブランチ

#### `main`ブランチ（本番環境）
- **直接push禁止**: すべての変更はプルリクエスト経由
- **レビュー必須**: 最低1名の承認が必要
- **ステータスチェック必須**: CI/CDパイプライン通過（将来実装予定）
- **管理者のみマージ可**: 本番リリース権限の制限

### ルール違反時の対処

```bash
# 直接pushを試行した場合のエラー例
remote: error: GH013: Repository rule violations found
remote: - Changes must be made through a pull request.
```

**対処法**
1. 作業内容をfeatureブランチに移動
2. プルリクエストを作成
3. 適切なレビュープロセスを経てマージ

## CI/CDパイプライン（GitHub Actions）

### ワークフロー概要

#### 1. `push-feature.yml`（feature系ブランチpush時）
- **トリガー**: `feature/**`, `fix/**`, `update/**`, `refactor/**`, `doc/**`, `test/**` ブランチへのpush
- **処理内容**:
  - 依存関係インストール（`npm ci`）
  - Lint実行（`npm run lint`）
  - ビルド検証（`npm run build`）
  - 成功時に `dev` ブランチ宛てのプルリクエストを自動作成・更新  
    - `dev` ブランチが存在しない場合は `main` から自動生成
    - PRタイトル/本文はドキュメント記載フォーマットに合わせたテンプレートを適用
- **成果物**: CI結果サマリー付き自動PR

#### 2. `merge-main.yml`（mainブランチpush時）
- **トリガー**: `main` ブランチへのpush（PRマージを含む）および手動実行
- **処理内容**:
  - lint & 本番ビルド検証
  - Lighthouse CI によるパフォーマンス監査（Performance 90%以上を必須化）
  - Core Web Vitals（FCP/LCP/TBT/CLS）の自動抽出とジョブサマリー出力
  - Lighthouseレポート（`.lighthouseci/`）のアーティファクト化
- **成果物**: 測定結果サマリーおよびダウンロード可能なレポート

### 詳細仕様

運用手順やチェック内容の詳細は [.github/workflows/README.md](../.github/workflows/README.md) を参照してください。

## デプロイメント戦略

### 自動デプロイメント

- **`main`ブランチ**: 本番環境に自動デプロイ（未設定・Vercel予定）
- **CI/CDチェック**: GitHub Actionsによる品質保証（未実装・将来実装予定）

### 手動デプロイメント

緊急時やロールバック時は、デプロイメント環境が確定次第、適切な方法で手動デプロイメント実行。基本的には自動デプロイメントを推奨。

### デプロイメント監視

- GitHub Actionsでのビルド状況確認（未実装・将来実装予定）
- Vercelダッシュボードでのビルド状況を監視（将来実装予定）
- デプロイ失敗時の自動通知設定（将来実装予定）
- ヘルスチェックと自動ロールバック（将来実装予定）

## 注意事項・ベストプラクティス

### 1. ブランチ管理

- **🔄 定期的な同期**: 長期作業時は定期的に`main`ブランチの変更を取り込む
- **📛 適切なブランチ名**: PREFIX/作業名の形式で作業内容が明確に分かる名前を使用
- **🗑️ 不要ブランチの削除**: マージ後は速やかにフィーチャーブランチを削除
- **🚫 直接push禁止**: `main`ブランチへの直接pushは絶対に行わない

### 2. コミット管理

- **🔸 小さな単位**: 機能ごとに細かくコミット
- **📝 明確なメッセージ**: PREFIXを使用した分かりやすいコミットメッセージ
- **⚛️ 原子性**: 1コミットで1つの論理的変更
- **🔍 レビュー前確認**: コミット前にlint・型チェックを実行

### 3. プルリクエスト

- **📋 詳細な説明**: 変更内容、テスト方法、影響範囲を記載
- **📸 スクリーンショット**: UI変更時は変更前後の画像を添付
- **👥 レビューア指定**: 適切なレビューアを指定
- **✅ CI/CD確認**: すべてのチェックが通過していることを確認

## トラブルシューティング

### ブランチ保護ルール関連

#### 直接pushエラーが発生した場合

```bash
# エラーが発生した場合の対処
# 1. 現在の変更を一時保存
git stash

# 2. 適切なfeatureブランチを作成
git checkout -b fix/emergency-fix

# 3. 変更を復元
git stash pop

# 4. コミット・プッシュ
git add .
git commit -m "FIX: 緊急修正内容"
git push origin fix/emergency-fix

# 5. プルリクエスト作成
```

### よくある問題と対処法

#### 1. ブランチ間の差分が大きくなった場合

```bash
# mainブランチの最新変更を取り込み
git checkout feature/your-feature
git pull origin main
git rebase main
```

#### 2. 間違ったブランチから作業を開始した場合

```bash
# 正しいベースブランチ（main）から新ブランチを作成
git checkout main
git pull origin main
git checkout -b feature/correct-feature-name

# 必要なコミットをcherry-pick
git cherry-pick <commit-hash>
```

#### 3. 直接pushしてしまった場合

```bash
# 直接pushした変更をrevert
git revert <commit-hash>
git push origin main

# 正しいプルリクエストフローで修正を再実装
```

#### 4. デプロイメントエラーが発生した場合（将来実装時）

1. Vercelダッシュボードでエラーログ確認
2. 前回成功したバージョンにロールバック
3. 問題修正後に再デプロイメント
4. 検証環境での十分なテスト実施

## 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要
- [CLAUDE.md](../CLAUDE.md) - 開発ガイドライン

---

## まとめ

### 必須ルール
1. **コミットメッセージ**: 必ず「PREFIX: 内容」形式
2. **プルリクエストタイトル**: 必ず「PREFIX: 内容」形式
3. **プルリクエスト説明**: 詳細な変更内容を記述
4. **直接push禁止**: mainブランチは保護済み
5. **レビュー必須**: すべてのプルリクエストに承認が必要

### 推奨事項
- 小さな単位でのコミット
- 明確で分かりやすいブランチ名
- 定期的なmainブランチとの同期
- 十分なテストとドキュメント更新
